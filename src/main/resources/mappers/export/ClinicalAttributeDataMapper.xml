<mapper namespace="org.cbioportal.application.file.export.mappers.ClinicalAttributeDataMapper">
    <select id="getClinicalSampleAttributes" resultType="org.cbioportal.application.file.model.ClinicalAttribute">
        SELECT
        cam.ATTR_ID as attributeId,
        cam.DISPLAY_NAME as displayName,
        cam.DESCRIPTION as description,
        cam.DATATYPE as datatype,
        cam.PRIORITY as priority
        FROM clinical_attribute_meta cam
        JOIN cancer_study cs ON cs.CANCER_STUDY_ID = cam.CANCER_STUDY_ID
        WHERE cs.CANCER_STUDY_IDENTIFIER = #{studyId} AND cam.PATIENT_ATTRIBUTE=false AND cam.ATTR_ID NOT IN (
        "MUTATION_COUNT", "FRACTION_GENOME_ALTERED"
        )
    </select>
    <select id="hasClinicalSampleAttributes" resultType="java.lang.Boolean">
        SELECT EXISTS (
        SELECT
        1
        FROM sample s ON
        JOIN patient p ON p.INTERNAL_ID = s.PATIENT_ID
        JOIN cancer_study cs ON cs.CANCER_STUDY_ID = cam.CANCER_STUDY_ID AND cs.CANCER_STUDY_ID = p.CANCER_STUDY_ID
        WHERE cs.CANCER_STUDY_IDENTIFIER = #{studyId}
        )
    </select>
    <select id="getClinicalSampleAttributeValues"
            resultType="org.cbioportal.application.file.model.ClinicalSampleAttributeValue"
            resultSetType="FORWARD_ONLY">
        SELECT
        p.STABLE_ID as patientId,
        s.STABLE_ID as sampleId,
        csa.ATTR_ID as attributeId,
        csa.ATTR_VALUE as attributeValue
        FROM sample s
        LEFT JOIN clinical_sample csa ON csa.INTERNAL_ID = s.INTERNAL_ID
        JOIN patient p ON p.INTERNAL_ID = s.PATIENT_ID
        JOIN cancer_study cs ON cs.CANCER_STUDY_ID = p.CANCER_STUDY_ID
        WHERE cs.CANCER_STUDY_IDENTIFIER = #{studyId} AND csa.ATTR_ID NOT IN (
        "MUTATION_COUNT", "FRACTION_GENOME_ALTERED"
        )
        ORDER BY s.INTERNAL_ID ASC
    </select>
    <select id="getClinicalPatientAttributes" resultType="org.cbioportal.application.file.model.ClinicalAttribute">
        SELECT
        cam.ATTR_ID as attributeId,
        cam.DISPLAY_NAME as displayName,
        cam.DESCRIPTION as description,
        cam.DATATYPE as datatype,
        cam.PRIORITY as priority
        FROM clinical_attribute_meta cam
        JOIN cancer_study cs ON cs.CANCER_STUDY_ID = cam.CANCER_STUDY_ID
        WHERE cs.CANCER_STUDY_IDENTIFIER = #{studyId} AND cam.PATIENT_ATTRIBUTE=true
    </select>
    <select id="hasClinicalPatientAttributes" resultType="java.lang.Boolean">
        SELECT EXISTS (
        SELECT
        1
        FROM patient p
        JOIN cancer_study cs ON cs.CANCER_STUDY_ID = cam.CANCER_STUDY_ID AND cs.CANCER_STUDY_ID = p.CANCER_STUDY_ID
        WHERE cs.CANCER_STUDY_IDENTIFIER = #{studyId}
        )
    </select>
    <select id="getClinicalPatientAttributeValues"
            resultType="org.cbioportal.application.file.model.ClinicalPatientAttributeValue"
            resultSetType="FORWARD_ONLY">
        SELECT
        p.STABLE_ID as patientId,
        cpa.ATTR_ID as attributeId,
        cpa.ATTR_VALUE as attributeValue
        FROM patient p
        LEFT JOIN clinical_patient cpa ON cpa.INTERNAL_ID = p.INTERNAL_ID
        JOIN cancer_study cs ON cs.CANCER_STUDY_ID = p.CANCER_STUDY_ID
        WHERE cs.CANCER_STUDY_IDENTIFIER = #{studyId}
        ORDER BY p.INTERNAL_ID ASC
    </select>
</mapper>
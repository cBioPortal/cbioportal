<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper  namespace="org.cbioportal.persistence.mybatisclickhouse.StudyViewMapper">
    <sql id="sampleUniqueIdsFromStudyViewFilter">
        <trim prefixOverrides="INTERSECT">
            <if test="studyViewFilter.studyIds != null and !studyViewFilter.studyIds.isEmpty()">
                INTERSECT 
                SELECT sample_unique_id
                FROM sample_derived
                WHERE cancer_study_identifier IN
                <foreach item="studyId" collection="studyViewFilter.studyIds" open="(" separator="," close=")">
                    #{studyId}
                </foreach>
            </if>
            <!-- filter for samples which belong to the sample lists (aka case lists) selected by the user and appearing in the studyViewFilter.caseLists collection -->
            <if test="studyViewFilter.caseLists != null and !studyViewFilter.caseLists.isEmpty()">
                INTERSECT
                -- case list filtering allows both UNION (OR) and INTERSECTION (AND) LOGIC
                -- caseLists is an array of arrays wherein the top level is INTERSECTION
                -- AND THE INTERNAL ARRAYS ARE UNION (OR)
                SELECT * FROM (
                    <foreach item="listGroup" collection="studyViewFilter.caseLists" separator="INTERSECT">
                        SELECT sample_unique_id
                        FROM sample_list_list sll
                        LEFT JOIN sample_derived s ON sll.sample_id=s.internal_id
                        LEFT JOIN sample_list sl on sll.list_id=sl.list_id
                        WHERE
                        <foreach item="list" collection="listGroup" separator="OR">
                            sl.stable_id LIKE '%_${list}'
                        </foreach>
                    </foreach>
                )
            </if>
                
            <if test="studyViewFilter.genomicProfiles != null and !studyViewFilter.genomicProfiles.isEmpty()">
                INTERSECT
                SELECT * FROM (
                <foreach item="ANDGroup" collection="studyViewFilter.genomicProfiles" separator="INTERSECT">
                    SELECT sample_derived.sample_unique_id
                    FROM sample_profile
                    JOIN genetic_profile gp ON sample_profile.genetic_profile_id = gp.genetic_profile_id
                    JOIN cancer_study cs ON gp.cancer_study_id = cs.cancer_study_id
                    JOIN sample_derived on sample_profile.sample_id = sample_derived.internal_id
                    <where>
                        sample_derived.cancer_study_identifier IN
                        <foreach item="studyId" collection="studyViewFilter.studyIds" open="(" separator="," close=")">
                            #{studyId}
                        </foreach>
                        AND 
                        <foreach item="genomicProfileId" collection="ANDGroup" open="(" separator="OR" close=")">
                            gp.stable_id LIKE '%_${genomicProfileId}'
                        </foreach>
                    </where>
                </foreach>
                )
                     
            </if>
  
            <if test="studyViewFilter.sampleIdentifiers != null and !studyViewFilter.sampleIdentifiers.isEmpty()">
                INTERSECT
                SELECT sample_unique_id
                FROM sample_derived
                WHERE sample_unique_id IN
                <foreach item="sampleIdentifier" collection="studyViewFilter.sampleIdentifiers" open="(" separator="," close=")">
                    '${sampleIdentifier.studyId}_${sampleIdentifier.sampleId}'
                </foreach>
            </if>
            <if test="studyViewFilter.geneFilters != null and !studyViewFilter.geneFilters.isEmpty()">
                <foreach item="profileGroup" collection="studyViewFilter.geneFilters">
                    <foreach item="geneFilterQueryList" collection="profileGroup.getGeneQueries()" open="INTERSECT" separator="INTERSECT">
                        SELECT sample_unique_id
                        FROM genomic_event_derived
                        <where>
                            genetic_profile_stable_id IN
                            <foreach item="molecularProfileId" collection="profileGroup.getMolecularProfileIds()" open="(" separator="," close=")">
                                #{molecularProfileId}
                            </foreach>
                        
                            <foreach item="geneFilterQuery" collection="geneFilterQueryList" open=" AND (" separator=") OR (" close=")">
                                hugo_gene_symbol = #{geneFilterQuery.hugoGeneSymbol}
                                <foreach item="alteration" collection="geneFilterQuery.getAlterations()" open="AND (" separator=") OR (" close=")">
                                   cna_alteration = #{alteration.code} 
                                </foreach>
                            </foreach>
                        </where>
                    </foreach>
                </foreach>
            </if>
            <if test="categorizedClinicalDataCountFilter.getSampleNumericalClinicalDataFilters() != null and !categorizedClinicalDataCountFilter.getSampleNumericalClinicalDataFilters().isEmpty()">
                <foreach item="clinicalDataFilter" collection="categorizedClinicalDataCountFilter.getSampleNumericalClinicalDataFilters()" open="INTERSECT" separator="INTERSECT">
                    <include refid="numericalClinicalDataCountFilter">
                        <property name="unique_id" value="sample_unique_id"/>
                        <property name="table_name" value="clinical_data_derived"/>
                        <property name="type" value="sample"/>
                    </include>
                </foreach>
            </if>
            <if test="categorizedClinicalDataCountFilter.getSampleCategoricalClinicalDataFilters() != null and !categorizedClinicalDataCountFilter.getSampleCategoricalClinicalDataFilters().isEmpty()">
                <foreach item="clinicalDataFilter" collection="categorizedClinicalDataCountFilter.getSampleCategoricalClinicalDataFilters()" open="INTERSECT" separator="INTERSECT">
                    <include refid="categoricalClinicalDataCountFilter">
                        <property name="unique_id" value="sample_unique_id"/>
                        <property name="table_name" value="clinical_data_derived"/>
                        <property name="type" value="sample"/>
                    </include>
                </foreach>
            </if>
            <!-- if mutationDataFilters are present and not empty, then we use them to further filter on samples -->
            <if test="studyViewFilter.mutationDataFilters != null and !studyViewFilter.mutationDataFilters.isEmpty()">
                <foreach item="mutationDataFilter" collection="studyViewFilter.mutationDataFilters">
                    <foreach item="dataFilterValues" collection="mutationDataFilter.getValues()" open="INTERSECT" separator="INTERSECT">
                        SELECT
                            DISTINCT sample_unique_id
                        FROM genomic_event_derived
                        <where>
                            mutation_type IN
                            <foreach item="dataFilterValue" collection="dataFilterValues" open="(" separator="," close=")">
                                #{dataFilterValue.value}
                            </foreach>
                        </where>
                    </foreach>
                </foreach>
            </if>
            <!-- if genomicDataFilters are present and not empty, then we use them to further filter on samples -->
            <if test="studyViewFilter.genomicDataFilters != null and !studyViewFilter.genomicDataFilters.isEmpty()">
                <foreach item="genomicDataFilter" collection="studyViewFilter.genomicDataFilters" open="INTERSECT" separator="INTERSECT">
                    <bind name="valueColumn" value="genomicDataFilter.profileType + '_value'" />
                    <bind name="containsNA" value="false" />
                    <foreach item="dataFilterValue" collection="genomicDataFilter.values">
                        <if test="dataFilterValue.value == 'NA'">
                            <bind name="containsNA" value="true" />
                        </if>
                    </foreach>
                    WITH cna_query AS (
                        SELECT sample_unique_id, ${valueColumn}
                        FROM genetic_alteration_derived_cna
                        WHERE hugo_gene_symbol = #{genomicDataFilter.hugoGeneSymbol}
                        AND cancer_study_identifier IN
                        <foreach item="studyId" collection="studyViewFilter.studyIds" open="(" separator="," close=")">
                            #{studyId}
                        </foreach>
                    )
                    SELECT DISTINCT sd.sample_unique_id
                    FROM sample_derived sd
                        LEFT JOIN cna_query ON sd.sample_unique_id = cna_query.sample_unique_id
                    WHERE cancer_study_identifier IN
                    <foreach item="studyId" collection="studyViewFilter.studyIds" open="(" separator="," close=")">
                        #{studyId}
                    </foreach>
                    <choose>
                        <when test="!containsNA"> <!-- if no 'NA' is selected -->
                            AND ${valueColumn} IN
                            <foreach item="dataFilterValue" collection="genomicDataFilter.values" open="(" separator="," close=")">
                                #{dataFilterValue.value}
                            </foreach>
                        </when>
                        <when test="genomicDataFilter.values.size() == 1 and genomicDataFilter.values[0].value == 'NA'"> <!-- else if only 'NA' is selected -->
                            AND ${valueColumn} IS NULL
                        </when>
                        <otherwise> <!-- else both 'NA' and other values are selected -->
                            AND (${valueColumn} IS NULL
                            OR ${valueColumn} IN
                            <foreach item="dataFilterValue" collection="genomicDataFilter.values" open="(" separator="," close=")">
                                <if test="dataFilterValue.value != 'NA'">#{dataFilterValue.value}</if>
                            </foreach>
                            )
                        </otherwise>
                    </choose>
                </foreach>
            </if>
            <!-- ... extend for other elements of the StudyViewFilter object -->
        </trim>
    </sql>

    <sql id="applyClinicalEventTypeFilter">
        <foreach item="clinicalEventFilter" collection="studyViewFilter.getClinicalEventFilters()" open="INTERSECT"
                 separator="INTERSECT">
            SELECT patient_unique_id
            FROM clinical_event_derived
            <where>
                <foreach item="dataFilterValue" collection="clinicalEventFilter.values" open="(" separator=") OR (" 
                         close=")">
                        event_type = '${dataFilterValue.value}'
                </foreach>
            </where>
        </foreach>
    </sql>
    
    <sql id="applyPatientTreatmentFilter">
        <foreach item="andedPatientTreatmentFilters" collection="studyViewFilter.getPatientTreatmentFilters().getFilters()" open="INTERSECT"
                 separator="INTERSECT">
            SELECT patient_unique_id
            FROM clinical_event_derived
            <where>
                <foreach item="patientTreatmentFilter" collection="andedPatientTreatmentFilters.getFilters()" open="(" separator=") OR ("
                         close=")">
                    event_type = 'Treatment'
                    AND key = 'AGENT'
                    AND value = '${patientTreatmentFilter.treatment}'
                </foreach>
            </where>
        </foreach> 
    </sql>

    <sql id="patientUniqueIdsFromStudyViewFilter">
        <trim prefixOverrides="INTERSECT">
            <if test="categorizedClinicalDataCountFilter.getPatientNumericalClinicalDataFilters() != null and !categorizedClinicalDataCountFilter.getPatientNumericalClinicalDataFilters().isEmpty()">
                <foreach item="clinicalDataFilter" collection="categorizedClinicalDataCountFilter.getPatientNumericalClinicalDataFilters()" open="INTERSECT" separator="INTERSECT">
                    <include refid="numericalClinicalDataCountFilter">
                        <property name="unique_id" value="patient_unique_id"/>
                        <property name="table_name" value="clinical_data_derived"/>
                        <property name="type" value="patient"/>
                    </include>
                </foreach>
            </if>
            <if test="categorizedClinicalDataCountFilter.getPatientCategoricalClinicalDataFilters() != null and !categorizedClinicalDataCountFilter.getPatientCategoricalClinicalDataFilters().isEmpty()">
                <foreach item="clinicalDataFilter" collection="categorizedClinicalDataCountFilter.getPatientCategoricalClinicalDataFilters()" open="INTERSECT" separator="INTERSECT">
                    <include refid="categoricalClinicalDataCountFilter">
                        <property name="unique_id" value="patient_unique_id"/>
                        <property name="table_name" value="clinical_data_derived"/>
                        <property name="type" value="patient"/>
                    </include>
                </foreach>
            </if>
            <!-- Clinical Event Filter -->
            <if test="studyViewFilter.getClinicalEventFilters() != null and !studyViewFilter.getClinicalEventFilters().isEmpty()">
                <include refid="applyClinicalEventTypeFilter"/>
            </if>
            <!-- Patient Treatment Filter -->
            <if test="studyViewFilter.getPatientTreatmentFilters() != null and !studyViewFilter.getPatientTreatmentFilters().getFilters().isEmpty()">
                <include refid="applyPatientTreatmentFilter"/>
            </if>
        </trim>
    </sql>

    <sql id="numericalClinicalDataCountFilter">
        SELECT ${unique_id}
        FROM ${table_name}
        WHERE attribute_name = '${clinicalDataFilter.attributeId}' AND
        type='${type}'
        <foreach item="dataFilterValue" collection="clinicalDataFilter.values" open=" AND ((" separator=") OR (" close="))">
            <trim prefix="" prefixOverrides="AND">
                <if test="dataFilterValue.value eq 'NA'">
                    AND
                    <include refid="isAttributeValueNA">
                        <property name="attribute_value" value="attribute_value"/>
                    </include>
                </if>
                <if test="dataFilterValue.start != null || dataFilterValue.end != null">
                    AND match(attribute_value, '^[\d\.]+$')
                    <choose>
                        <when test="dataFilterValue.start == dataFilterValue.end">
                            AND abs(minus(cast(attribute_value as float), ${dataFilterValue.start})) &lt; exp(-11)
                        </when>
                        <otherwise>
                            <if test="dataFilterValue.start != null">
                                AND cast(attribute_value as float) &gt; ${dataFilterValue.start}
                            </if>
                            <if test="dataFilterValue.end != null">
                                AND cast(attribute_value as float) &lt;= ${dataFilterValue.end}
                            </if>
                        </otherwise>
                    </choose>
                </if>
            </trim>
        </foreach>

    </sql>
    <sql id="categoricalClinicalDataCountFilter">
        SELECT ${unique_id}
        FROM ${table_name}
        WHERE attribute_name = '${clinicalDataFilter.attributeId}' AND
        type='${type}'
        <foreach item="dataFilterValue" collection="clinicalDataFilter.values" open=" AND ((" separator=") OR (" close="))">
            <trim prefix="" prefixOverrides="AND">
                AND attribute_value = '${dataFilterValue.value}'
            </trim>
        </foreach>
    </sql>
</mapper>
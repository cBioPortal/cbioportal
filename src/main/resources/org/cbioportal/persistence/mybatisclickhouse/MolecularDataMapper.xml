<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cbioportal.legacy.persistence.mybatisclickhouse.MolecularDataMapper">

    <!-- Return one row per sample for a given set of molecular profiles and entrez gene ids.
         The repository will aggregate these into the expected CSV 'values' for each gene-profile pair.
    -->
    <select id="getGeneMolecularAlterationsPerSampleInMultipleMolecularProfiles" resultType="org.cbioportal.legacy.model.MolecularDataRowPerSample">
        SELECT
            g.entrez_gene_id AS "entrezGeneId",
            gad.hugo_gene_symbol AS "hugoGeneSymbol",
            gad.alteration_value AS "value",
            gad.profile_type AS "molecularProfileId",
            gad.sample_unique_id AS "sampleUniqueId"
        FROM genetic_alteration_derived gad
        LEFT JOIN gene g ON g.hugo_gene_symbol = gad.hugo_gene_symbol
        <where>
            gad.profile_type IN
            <foreach item="item" collection="molecularProfileIds" open="(" separator="," close=")">
                #{item}
            </foreach>
            <if test="entrezGeneIds != null and !entrezGeneIds.isEmpty()">
                AND g.entrez_gene_id IN
                <foreach item="item" collection="entrezGeneIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

</mapper>

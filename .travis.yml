services:
    - docker
    - mysql

sudo: required
language: java
jdk:
    - openjdk7

env:
    - MAVEN_VERSION=3.3.3

cache:
    directories:
        - $HOME/.m2
        - $HOME/maven

install:
    # install mysql
    - sudo apt-get update
    - sudo apt-get install -y mysql-server
    - sudo mysql_install_db
    # installl maven
    - mkdir -p ~/maven
    - |
        test -d ~/maven/$MAVEN_VERSION/bin || { \
            find ~/maven -mindepth 1 -delete && \
            mkdir -p ~/maven/$MAVEN_VERSION && \
            wget -O - http://www.eu.apache.org/dist/maven/maven-3/$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz | \
                tar -C ~/maven/$MAVEN_VERSION --strip-components=1 -xzf -; }

before_script:
    # create mysql db for core test
    - |
        mysql -u root -e "CREATE DATABASE cbioportal; \
                          CREATE DATABASE cgds_test; \
                          CREATE USER 'cbio_user'@'localhost' IDENTIFIED BY 'somepassword'; \
                          GRANT ALL ON cbioportal.* TO 'cbio_user'@'localhost'; \
                          GRANT ALL ON cgds_test.* TO 'cbio_user'@'localhost'; \
                          flush privileges; " 
    # copy settings for core database
    - mkdir -p ~/.m2
    - cp .travis/settings.xml ~/.m2

script:
    - export PORTAL_HOME=$(pwd)
    # core tests
    - cp $PORTAL_HOME/src/main/resources/portal.properties.EXAMPLE $PORTAL_HOME/src/main/resources/portal.properties
    - cp $PORTAL_HOME/src/main/resources/log4j.properties.EXAMPLE $PORTAL_HOME/src/main/resources/log4j.properties
    - chmod -R 777 .
    - |
        docker run \
            -v $PWD:/cbioportal \
            -e PORTAL_HOME=/cbioportal \
            maven:3.3-jdk-7 \
                /bin/bash -c \
                'cd $PORTAL_HOME &&
                mvn -e \
                -DPORTAL_HOME=$PORTAL_HOME \
                -Ppublic \
                -Ddb.host=localhost \
                -Ddb.connection_string=jdbc:mysql://localhost:3306/ \
                clean test'
    - |
        ~/maven/$MAVEN_VERSION/bin/mvn \
            -e -DPORTAL_HOME=$PORTAL_HOME \
            -Ddb.host=localhost \
            -Ddb.connection_string=jdbc:mysql://localhost:3306/ \
            -Ppublic \
            clean test
    # end-to-end tests
    - |
        ~/maven/$MAVEN_VERSION/bin/mvn \
            -e -DPORTAL_HOME=$PORTAL_HOME \
            -Ppublic -DskipTests \
            -Ddb.user=cbio_user \
            -Ddb.password=cbio_pass \
            -Ddb.portal_db_name=public_test \
            -Ddb.connection_string=jdbc:mysql://cbioportal-public.c1xhhbwn8izk.us-east-1.rds.amazonaws.com:3306/ \
            -Ddb.host=cbioportal-public.c1xhhbwn8izk.us-east-1.rds.amazonaws.com \
            clean install
    - cd test/end-to-end
    - docker-compose up -d
    - sleep 30s
    - cd ../..
    - bash test/end-to-end/test_make_screenshots.sh test/end-to-end/screenshots.yml

notifications:
  slack: cbioportal:S2qVTFTFMtizONhCOe8BYxS6

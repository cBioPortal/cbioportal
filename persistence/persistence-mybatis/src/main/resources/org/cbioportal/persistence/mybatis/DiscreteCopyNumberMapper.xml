<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cbioportal.persistence.mybatis.DiscreteCopyNumberMapper">
    <cache/>

    <sql id="select">
        genetic_profile.STABLE_ID AS geneticProfileId,
        sample.STABLE_ID AS sampleId,
        cna_event.ENTREZ_GENE_ID as entrezGeneId,
        cna_event.ALTERATION AS alteration
        <if test="projection == 'DETAILED'">
            ,
            <include refid="org.cbioportal.persistence.mybatis.GeneMapper.select">
                <property name="prefix" value="gene."/>
            </include>
        </if>
    </sql>

    <sql id="from">
        FROM cna_event
        INNER JOIN sample_cna_event ON cna_event.CNA_EVENT_ID = sample_cna_event.CNA_EVENT_ID
        INNER JOIN genetic_profile ON sample_cna_event.GENETIC_PROFILE_ID = genetic_profile.GENETIC_PROFILE_ID
        INNER JOIN sample ON sample_cna_event.SAMPLE_ID = sample.INTERNAL_ID
    </sql>

    <sql id="where">
        <where>
            genetic_profile.STABLE_ID = #{geneticProfileId}
            <if test="sampleIds != null and !sampleIds.isEmpty()">
                AND sample.STABLE_ID IN
                <foreach item="item" collection="sampleIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="alterations != null and !alterations.isEmpty()">
                AND cna_event.ALTERATION IN
                <foreach item="item" collection="alterations" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </sql>

    <select id="getDiscreteCopyNumbers" resultType="org.cbioportal.model.DiscreteCopyNumberData">
        SELECT
        <include refid="select"/>
        <include refid="from"/>
        <if test="projection == 'DETAILED'">
            INNER JOIN gene ON cna_event.ENTREZ_GENE_ID = gene.ENTREZ_GENE_ID
        </if>
        <include refid="where"/>
    </select>

    <select id="getMetaDiscreteCopyNumbers" resultType="org.cbioportal.model.meta.BaseMeta">
        SELECT
        COUNT(*) AS totalCount
        <include refid="from"/>
        <include refid="where"/>
    </select>
</mapper>
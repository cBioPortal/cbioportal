services:
    - docker
    - mysql

sudo: required

before_script:
    # copy settings for core database
    - mkdir -p ~/.m2
    - cp .travis/settings.xml ~/.m2

install:
    - sudo apt-get install mysql-server
    - mysql_install_db
    - /usr/bin/mysqld_safe
    - |
        mysql -u root -e "CREATE DATABASE cbioportal; \
                          CREATE DATABASE cgds_test; \
                          CREATE USER 'cbio_user'@'localhost' IDENTIFIED BY 'somepassword'; \
                          GRANT ALL ON cbioportal.* TO 'cbio_user'@'localhost'; \
                          GRANT ALL ON cgds_test.* TO 'cbio_user'@'localhost'; \
                          flush privileges; " 

script:
    - export PORTAL_HOME=$(pwd)
    # run mysql db for core tests
    - echo 'show tables;' | mysql --user cbio_user -h localhost -P 3306 --password=somepassword cgds_test
    - |
        docker run --name core-tests-mysql \
                 -e MYSQL_USER=cbio_user \
                 -e MYSQL_ALLOW_EMPTY_PASSWORD=yes \
                 -e MYSQL_PASSWORD=somepassword \
                 -e MYSQL_DATABASE=cgds_test \
                 -d mysql:5.7.12
    #expose port to host -p 3306:3306
    # core tests
    - cp $PORTAL_HOME/src/main/resources/portal.properties.EXAMPLE $PORTAL_HOME/src/main/resources/portal.properties
    - cp $PORTAL_HOME/src/main/resources/log4j.properties.EXAMPLE $PORTAL_HOME/src/main/resources/log4j.properties
    - echo 'show tables;' | mysql --user cbio_user -h 127.0.0.1 -P 3306 --password=somepassword cgds_test
    - |
        docker run --rm --link=core-tests-mysql:db \
            -e PORTAL_HOME=/cbioportal \
            -v $PWD:/cbioportal \
            mysql:5.7.12 \
                /bin/bash -c 'echo "show tables;" | mysql --user cbio_user --host=db -P 3306 --password=somepassword cgds_test'
    - docker ps
    - docker inspect core-tests-mysql
    - |
        ~/maven/$MAVEN_VERSION/bin/mvn \
            -e -DPORTAL_HOME=$PORTAL_HOME \
            -Ddb.host=127.0.0.1 \
            -Ddb.connection_string=jdbc:mysql://127.0.0.1:3306/ \
            -Ppublic \
            clean test
    # end-to-end tests
    - |
        ~/maven/$MAVEN_VERSION/bin/mvn \
            -e -DPORTAL_HOME=$PORTAL_HOME \
            -Ppublic -DskipTests \
            -Ddb.user=cbio_user \
            -Ddb.password=cbio_pass \
            -Ddb.portal_db_name=public_test \
            -Ddb.connection_string=jdbc:mysql://cbioportal-public.c1xhhbwn8izk.us-east-1.rds.amazonaws.com:3306/ \
            -Ddb.host=cbioportal-public.c1xhhbwn8izk.us-east-1.rds.amazonaws.com \
            clean install
    - java -Ddbconnector=dbcp -jar portal/target/dependency/webapp-runner.jar --expand-war portal/target/cbioportal.war &
    - sleep 20s
    - bash test/end-to-end/test_make_screenshots.sh

notifications:
  slack: cbioportal:S2qVTFTFMtizONhCOe8BYxS6

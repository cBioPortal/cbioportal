sudo: required
language: java
jdk: oraclejdk7

cache:
    directories:
        - $HOME/.m2
        - $HOME/maven

env:
    - MAVEN_VERSION=3.3.3

install:
    - mkdir -p ~/maven
    - |
        test -d ~/maven/$MAVEN_VERSION/bin || { \
            find ~/maven -mindepth 1 -delete && \
            mkdir -p ~/maven/$MAVEN_VERSION && \
            wget -O - http://www.eu.apache.org/dist/maven/maven-3/$MAVEN_VERSION/binaries/apache-maven-$MAVEN_VERSION-bin.tar.gz | \
                tar -C ~/maven/$MAVEN_VERSION --strip-components=1 -xzf -; }
    - sudo apt-get update && sudo apt-get -y install python-pip
    - sudo pip install Jinja2
    - sudo pip install MySQL-python
    - sudo pip install requests

before_script:
    - mkdir -p ~/.m2
    - cp .travis/settings.xml ~/.m2
    - mysql --user travis --password= <<< 'CREATE DATABASE cgds_test'

script:
    - export PORTAL_HOME=$(pwd)
    - export PYTHONPATH=$PORTAL_HOME/core/src/main/scripts
    - cd $PORTAL_HOME/core/src/test/scripts/
    - $PORTAL_HOME/core/src/test/scripts/./unit_tests_validate_data.py
    - $PORTAL_HOME/core/src/test/scripts/./system_tests_validate_data.py
    - cd $PORTAL_HOME
    - cp .travis/src/main/resources/portal.properties $PORTAL_HOME/src/main/resources/portal.properties
    - cp .travis/src/main/resources/log4j.properties $PORTAL_HOME/src/main/resources/log4j.properties
    - ~/maven/$MAVEN_VERSION/bin/mvn -e -DPORTAL_HOME=$PORTAL_HOME -Ppublic clean test
    - cp $PORTAL_HOME/src/main/resources/portal.properties.EXAMPLE $PORTAL_HOME/src/main/resources/portal.properties
    - cp $PORTAL_HOME/src/main/resources/log4j.properties.EXAMPLE $PORTAL_HOME/src/main/resources/log4j.properties
    - ~/maven/$MAVEN_VERSION/bin/mvn -e -DPORTAL_HOME=$PORTAL_HOME -Ppublic -DskipTests -Ddb.user=cbio_user -Ddb.password=cbio_pass -Ddb.portal_db_name=public_test -Ddb.connection_string=jdbc:mysql://cbioportal-public.c1xhhbwn8izk.us-east-1.rds.amazonaws.com:3306/ -Ddb.host=cbioportal-public.c1xhhbwn8izk.us-east-1.rds.amazonaws.com clean install
    - java -Ddbconnector=dbcp -jar portal/target/dependency/webapp-runner.jar --expand-war portal/target/cbioportal.war &
    - sleep 20s
    - bash test/end-to-end/test_make_screenshots.sh

notifications:
  slack: cbioportal:S2qVTFTFMtizONhCOe8BYxS6
  

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cbioportal.persistence.mybatis.TreatmentMapper">

    <select id="getAllTreatments" resultType="org.cbioportal.model.Treatment">
        SELECT
            clinical_event_data.value as treatment,
            patient.stable_id as patientId,
            cancer_study.cancer_study_identifier as studyId,
            clinical_event.start_date as start,
            clinical_event.stop_date as stop
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.clinical_event_id = clinical_event_data.clinical_event_id
            INNER JOIN patient ON clinical_event.patient_id = patient.internal_id
            INNER JOIN sample ON patient.internal_id = sample.patient_id
            INNER JOIN cancer_study ON patient.cancer_study_id = cancer_study.cancer_study_id
        <include refid="where"/>
        AND clinical_event.event_type = 'TREATMENT'
        AND clinical_event_data.key = #{key}
    </select>

    <select id="getAllSamples" resultType="org.cbioportal.model.ClinicalEventSample">
        SELECT
            sample.stable_id as sampleId,
            patient.stable_id as patientId,
            cancer_study.cancer_study_identifier as studyId,
            clinical_event.start_date as timeTaken
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.clinical_event_id = clinical_event_data.clinical_event_id
            INNER JOIN patient ON clinical_event.patient_id = patient.internal_id
            INNER JOIN sample ON clinical_event_data.value = sample.stable_id
            INNER JOIN cancer_study ON patient.cancer_study_id = cancer_study.cancer_study_id
        <include refid="where"/>
            AND clinical_event_data.key = 'sample_id'
            AND (clinical_event.event_type LIKE 'Sample Acquisition' OR clinical_event.event_type LIKE 'SPECIMEN')
    </select>

    <select id="getAllShallowSamples" resultType="org.cbioportal.model.ClinicalEventSample">
        SELECT
            sample.stable_id as sampleId,
            patient.stable_id as patientId,
            cancer_study.cancer_study_identifier as studyId
        FROM
            sample
            INNER JOIN patient ON sample.patient_id = patient.internal_id
            INNER JOIN cancer_study ON patient.cancer_study_id = cancer_study.cancer_study_id
        <include refid="where"/>
    </select>

    <select id="hasTreatmentData" resultType="java.lang.Boolean">
        SELECT EXISTS(SELECT
            *
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.clinical_event_id = clinical_event_data.clinical_event_id
            INNER JOIN patient ON clinical_event.patient_id = patient.internal_id
            INNER JOIN sample ON patient.internal_id = sample.patient_id
            INNER JOIN cancer_study ON patient.cancer_study_id = cancer_study.cancer_study_id
        <include refid="where"/>
            AND clinical_event.event_type = 'TREATMENT'
            AND clinical_event_data.key = #{key} LIMIT 1
        )
    </select>

    <select id="hasSampleTimelineData" resultType="java.lang.Boolean">
        SELECT EXISTS(SELECT
            *
        FROM
            clinical_event
            INNER JOIN clinical_event_data ON clinical_event.clinical_event_id = clinical_event_data.clinical_event_id
            INNER JOIN patient ON clinical_event.patient_id = patient.internal_id
            INNER JOIN sample ON clinical_event_data.value = sample.stable_id
            INNER JOIN cancer_study ON patient.cancer_study_id = cancer_study.cancer_study_id
        <include refid="where"/>
            AND clinical_event_data.key = 'sample_id'
            AND (clinical_event.event_type LIKE 'Sample Acquisition' OR clinical_event.event_type LIKE 'SPECIMEN') LIMIT 1)
    </select>

    <sql id="where">
        <where>
            <if test="sampleIds == null and studyIds != null">
                cancer_study.cancer_study_identifier IN
                <if test="studyIds.isEmpty()">
                    (NULL)
                </if>
                <if test="!studyIds.isEmpty()">
                    <foreach item="item" collection="studyIds" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                </if>
            </if>
            <if test="sampleIds != null">
                <if test="@java.util.Arrays@stream(studyIds.toArray()).distinct().count() == 1">
                    cancer_study.cancer_study_identifier = #{studyIds[0]} AND
                    sample.stable_id IN
                    <foreach item="item" collection="sampleIds" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                </if>
                <if test="@java.util.Arrays@stream(studyIds.toArray()).distinct().count() > 1">
                    cancer_study.cancer_study_identifier IN
                        <foreach item="item" collection="@java.util.Arrays@stream(studyIds.toArray()).distinct().collect(@java.util.stream.Collectors@toList())" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                    AND (cancer_study.cancer_study_identifier, sample.stable_id) IN
                    <foreach index="i" collection="sampleIds" open="(" separator="," close=")">
                        (#{studyIds[${i}]}, #{sampleIds[${i}]})
                    </foreach>
                </if>
            </if>
        </where>
    </sql>
</mapper>
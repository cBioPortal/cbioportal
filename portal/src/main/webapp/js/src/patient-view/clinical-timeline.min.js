/* cBioPortal Clinical Timeline v0.0.9 | Maintained @ github.com/cbioportal/clinical-timeline */
(function(){d3.timeline=function(){var DISPLAY_TYPES=["circle","rect"];var hover=function(){},mouseover=function(){},mouseout=function(){},click=function(){},scroll=function(){},orient="bottom",width=null,height=null,rowSeperatorsColor=null,backgroundColor=null,translateX=0,tickFormat={format:function(d){var format=d3.time.format("%I %p");return format(d)},tickTime:d3.time.hours,tickInterval:1,tickSize:6,tickValues:null},colorCycle=d3.scale.category20(),colorPropertyName=null,display="rect",beginning=0,ending=0,margin={left:30,right:30,top:30,bottom:30},stacked=false,stackSlack=0,rotateTicks=false,timeIsRelative=false,itemHeight=20,itemMinWidth=5,itemMargin=5,showTimeAxis=true,showTodayLine=false,timeAxisTick=false,timeAxisTickFormat={stroke:"stroke-dasharray",spacing:"4 10"},showTodayFormat={marginTop:25,marginBottom:0,width:1,color:colorCycle},showBorderLine=false,showBorderFormat={marginTop:25,marginBottom:0,width:1,color:colorCycle},scrolledX=null;function timeline(gParent){var g=gParent.append("g");var gParentSize=gParent[0][0].getBoundingClientRect();var gParentItem=d3.select(gParent[0][0]);var yAxisMapping={},maxStack=1,minTime=0,maxTime=0;setWidth();if(timeIsRelative){g.each(function(d,i){d.forEach(function(datum,index){datum.times.forEach(function(time,j){if(index===0&&j===0){originTime=time.starting_time;time.starting_time=0;time.ending_time=time.ending_time-originTime}else{time.starting_time=time.starting_time-originTime;time.ending_time=time.ending_time-originTime}})})})}if(stacked||ending===0||beginning===0){g.each(function(d,i){d.forEach(function(datum,index){var overlapMaxStack=0;if(!datum.collapse){var overlapGroups=groupByOverlap(datum.times,stackSlack);overlapGroups.forEach(function(overlapGroup,j){var overlapStack=0;overlapGroup.forEach(function(time,k){time.stack=maxStack+overlapStack;if(overlapStack>overlapMaxStack){overlapMaxStack=overlapStack}overlapStack++})})}else{datum.times.forEach(function(t){t.stack=maxStack})}if(stacked&&Object.keys(yAxisMapping).indexOf(index)==-1){yAxisMapping[index]=maxStack;maxStack++}maxStack=maxStack+overlapMaxStack;datum.times.forEach(function(time,i){if(beginning===0)if(time.starting_time<minTime||minTime===0&&timeIsRelative===false)minTime=time.starting_time;if(ending===0)if(time.ending_time>maxTime)maxTime=time.ending_time})})});if(ending===0){ending=maxTime}if(beginning===0){beginning=minTime}}var scaleFactor=1/(ending-beginning)*(width-margin.left-margin.right);var xScale=d3.time.scale().domain([beginning,ending]).range([margin.left,width-margin.right]);var xAxis=d3.svg.axis().scale(xScale).orient(orient).tickFormat(tickFormat.format).tickSize(tickFormat.tickSize);if(tickFormat.tickValues!==null){xAxis.tickValues(tickFormat.tickValues)}else{xAxis.ticks(tickFormat.numTicks||tickFormat.tickTime,tickFormat.tickInterval)}if(showTimeAxis){g.append("g").attr("class","axis").attr("transform","translate("+0+","+(margin.top+(itemHeight+itemMargin)*maxStack)+")").call(xAxis)}if(timeAxisTick){g.append("g").attr("class","axis").attr("transform","translate("+0+","+(margin.top+(itemHeight+itemMargin)*maxStack)+")").attr(timeAxisTickFormat.stroke,timeAxisTickFormat.spacing).call(xAxis.tickFormat("").tickSize(-(margin.top+(itemHeight+itemMargin)*(maxStack-1)+3),0,0))}g.each(function(d,i){d.forEach(function(datum,index){var data=datum.times;var hasLabel=typeof datum.label!="undefined";if(typeof datum.id!="undefined"){console.warn("d3Timeline Warning: Ids per dataset is deprecated in favor of a 'class' key. Ids are now per data element.")}if(backgroundColor){var greenbarYAxis=(itemHeight+itemMargin)*yAxisMapping[index];g.selectAll("svg").data(data).enter().insert("rect").attr("class","row-green-bar").attr("x",0+margin.left).attr("width",width-margin.right-margin.left).attr("y",greenbarYAxis).attr("height",itemHeight).attr("fill",backgroundColor)}var timePoints=g.selectAll("svg").data(data).enter().append(getShape).attr("x",getXPos).attr("y",getStackPosition).attr("width",getWidth).attr("cy",function(d,i){return getStackPosition(d,i)+itemHeight/2}).attr("cx",getXPos).attr("r",getHeight).attr("height",getHeight).style("fill",function(d,i){var dColorPropName;if("display"in d&&d.display.split(" ").indexOf("unfilled")!==-1){return"rgb(255, 255, 255)"}if(d.color)return d.color;if(colorPropertyName){dColorPropName=d[colorPropertyName];if(dColorPropName){return colorCycle(dColorPropName)}else{return colorCycle(datum[colorPropertyName])}}else if(hasLabel){return colorCycle(datum.label)}return colorCycle(index)}).style("stroke",function(d,i){if("display"in d&&d.display.split(" ").indexOf("unfilled")!==-1){if(d.color)return d.color;if(hasLabel)return colorCycle(datum.label);return colorCycle(index)}}).attr("filter",function(d,i){if("display"in d&&d.display.split(" ").indexOf("dropshadow")!==-1){return"url(#dropshadow)"}else{return""}}).on("mousemove",function(d,i){hover(d,index,datum)}).on("mouseover",function(d,i){mouseover(d,i,datum)}).on("mouseout",function(d,i){mouseout(d,i,datum)}).on("click",function(d,i){click(d,index,datum)}).attr("class",function(d,i){return datum.class?"timelineSeries_"+datum.class:"timelineSeries_"+index}).attr("id",function(d,i){if(datum.id&&!d.id){return"timelineItem_"+datum.id}return d.id?d.id:"timelineItem_"+index+"_"+i});g.selectAll("svg").data(data).enter().append("text").attr("x",getXTextPos).attr("y",getStackTextPosition).text(function(d){return d.label});if(rowSeperatorsColor){var lineYAxis=itemHeight+itemMargin/2+margin.top+(itemHeight+itemMargin)*yAxisMapping[index];gParent.append("svg:line").attr("class","row-seperator").attr("x1",0+margin.left).attr("x2",width-margin.right).attr("y1",lineYAxis).attr("y2",lineYAxis).attr("stroke-width",1).attr("stroke",rowSeperatorsColor)}if(hasLabel){gParent.append("text").attr("class","timeline-label").attr("transform","translate("+0+","+(itemHeight*.75+margin.top+(itemHeight+itemMargin)*yAxisMapping[index])+")").text(hasLabel?datum.label:datum.id).on("click",function(d,i){click(d,index,datum)})}if(typeof datum.icon!=="undefined"){gParent.append("image").attr("class","timeline-label").attr("transform","translate("+0+","+(margin.top+(itemHeight+itemMargin)*yAxisMapping[index])+")").attr("xlink:href",datum.icon).attr("width",margin.left).attr("height",itemHeight)}function getStackPosition(d,i){if(stacked){return margin.top+(itemHeight+itemMargin)*d.stack}return margin.top}function getStackTextPosition(d,i){if(stacked){return margin.top+(itemHeight+itemMargin)*yAxisMapping[index]+itemHeight*.75}return margin.top+itemHeight*.75}})});if(width>gParentSize.width){var move=function(){var x=Math.min(0,Math.max(gParentSize.width-width,d3.event.translate[0]));zoom.translate([x,0]);g.attr("transform","translate("+x+",0)");scroll(x*scaleFactor,xScale);scrolledX=x};var zoom=d3.behavior.zoom().x(xScale).on("zoom",move);gParent.attr("class","scrollable").call(zoom);zoom.translate([translateX,0]);zoom.event(gParent)}if(rotateTicks){g.selectAll(".tick text").attr("transform",function(d){return"rotate("+rotateTicks+")translate("+(this.getBBox().width/2+10)+","+this.getBBox().height/2+")"})}var gSize=g[0][0].getBoundingClientRect();setHeight();if(showBorderLine){g.each(function(d,i){d.forEach(function(datum){var times=datum.times;times.forEach(function(time){appendLine(xScale(time.starting_time),showBorderFormat);appendLine(xScale(time.ending_time),showBorderFormat)})})})}if(showTodayLine){var todayLine=xScale(new Date);appendLine(todayLine,showTodayFormat)}function groupByOverlap(times,slack){var end=-Infinity,groups=[],group=[];var sortedTimes=times.sort(function(a,b){return parseInt(a.starting_time)-parseInt(b.starting_time)});for(var i=0;i<sortedTimes.length;i++){if(parseInt(sortedTimes[i].starting_time)===parseInt(sortedTimes[i].ending_time)&&parseInt(sortedTimes[i].starting_time)<=parseInt(end)+slack||parseInt(sortedTimes[i].starting_time)!==parseInt(sortedTimes[i].ending_time)&&parseInt(sortedTimes[i].starting_time)<parseInt(end)){group.push(sortedTimes[i]);if(parseInt(sortedTimes[i].ending_time)>end){end=parseInt(sortedTimes[i].ending_time)}}else{if(group.length>0){groups.push(group)}group=[sortedTimes[i]];end=parseInt(sortedTimes[i].ending_time)}}groups.push(group);return groups}function getShape(d,i){var shape;if("display"in d){if(d.display==="rect"||d.display==="circle"){shape=d.display}else if(d.display==="square"){shape="rect"}else if(d.display.split(" ").indexOf("circle")!==-1){shape="circle"}else{console.warn("d3Timeline Warning: unrecognized display attribute: "+d.display)}}else{shape=display}return document.createElementNS(d3.ns.prefix.svg,shape)}function getHeight(d,i){return parseInt(d.size)||itemHeight}function getWidth(d,i){if("display"in d&&d.display==="square"){return itemHeight}else{var width=(d.ending_time-d.starting_time)*scaleFactor;if(width<itemMinWidth){width=itemMinWidth}return width}}function getXPos(d,i){if("display"in d&&d.display==="square"){return margin.left+(d.starting_time-beginning)*scaleFactor-itemHeight/2}else{return margin.left+(d.starting_time-beginning)*scaleFactor}}function getXTextPos(d,i){return margin.left+(d.starting_time-beginning)*scaleFactor+5}function setHeight(){if(!height&&!gParentItem.attr("height")){if(itemHeight){height=gSize.height+gSize.top-gParentSize.top;d3.select(gParent[0][0]).attr("height",height)}else{throw"height of the timeline is not set"}}else{if(!height){height=gParentItem.attr("height")}else{gParentItem.attr("height",height)}}}function setWidth(){if(!width&&!gParentSize.width){try{width=gParentItem.attr("width");if(!width){throw"width of the timeline is not set. As of Firefox 27, timeline().with(x) needs to be explicitly set in order to render"}}catch(err){console.log(err)}}else if(!(width&&gParentSize.width)){try{width=gParentItem.attr("width")}catch(err){console.log(err)}}}function appendLine(lineScale,lineFormat){gParent.append("svg:line").attr("x1",lineScale).attr("y1",lineFormat.marginTop).attr("x2",lineScale).attr("y2",height-lineFormat.marginBottom).style("stroke",lineFormat.color).style("stroke-width",lineFormat.width)}}timeline.margin=function(p){if(!arguments.length)return margin;margin=p;return timeline};timeline.orient=function(orientation){if(!arguments.length)return orient;orient=orientation;return timeline};timeline.itemHeight=function(h){if(!arguments.length)return itemHeight;itemHeight=h;return timeline};timeline.itemMinWidth=function(h){if(!arguments.length)return itemMinWidth;itemMinWidth=h;return timeline};timeline.itemMargin=function(h){if(!arguments.length)return itemMargin;itemMargin=h;return timeline};timeline.height=function(h){if(!arguments.length)return height;height=h;return timeline};timeline.width=function(w){if(!arguments.length)return width;width=w;return timeline};timeline.display=function(displayType){if(!arguments.length||DISPLAY_TYPES.indexOf(displayType)==-1)return display;display=displayType;return timeline};timeline.tickFormat=function(format){if(!arguments.length)return tickFormat;tickFormat=format;return timeline};timeline.hover=function(hoverFunc){if(!arguments.length)return hover;hover=hoverFunc;return timeline};timeline.mouseover=function(mouseoverFunc){if(!arguments.length)return mouseoverFunc;mouseover=mouseoverFunc;return timeline};timeline.mouseout=function(mouseoverFunc){if(!arguments.length)return mouseoverFunc;mouseout=mouseoverFunc;return timeline};timeline.click=function(clickFunc){if(!arguments.length)return click;click=clickFunc;return timeline};timeline.scroll=function(scrollFunc){if(!arguments.length)return scroll;scroll=scrollFunc;return timeline};timeline.colors=function(colorFormat){if(!arguments.length)return colorCycle;colorCycle=colorFormat;return timeline};timeline.beginning=function(b){if(!arguments.length)return beginning;beginning=b;return timeline};timeline.ending=function(e){if(!arguments.length)return ending;ending=e;return timeline};timeline.rotateTicks=function(degrees){rotateTicks=degrees;return timeline};timeline.stack=function(){stacked=!stacked;return timeline};timeline.stackSlack=function(){if(!arguments.length)return stackSlack;return timeline};timeline.relativeTime=function(){timeIsRelative=!timeIsRelative;return timeline};timeline.showBorderLine=function(){showBorderLine=!showBorderLine;return timeline};timeline.showBorderFormat=function(borderFormat){if(!arguments.length)return showBorderFormat;showBorderFormat=borderFormat;return timeline};timeline.showToday=function(){showTodayLine=!showTodayLine;return timeline};timeline.showTodayFormat=function(todayFormat){if(!arguments.length)return showTodayFormat;showTodayFormat=todayFormat;return timeline};timeline.colorProperty=function(colorProp){if(!arguments.length)return colorPropertyName;colorPropertyName=colorProp;return timeline};timeline.rowSeperators=function(color){if(!arguments.length)return rowSeperatorsColor;rowSeperatorsColor=color;return timeline};timeline.background=function(color){if(!arguments.length)return backgroundColor;backgroundColor=color;return timeline};timeline.showTimeAxis=function(){showTimeAxis=!showTimeAxis;return timeline};timeline.showTimeAxisTick=function(){timeAxisTick=!timeAxisTick;return timeline};timeline.showTimeAxisTickFormat=function(format){if(!arguments.length)return timeAxisTickFormat;timeAxisTickFormat=format;return timeline};timeline.translate=function(x){if(!arguments.length)return translateX;translateX=x;return timeline};timeline.scrolledX=function(x){if(!arguments.length)return scrolledX;scrolledX=x;return timeline};return timeline}})();function configCheckManager(name,spec){clinicalTimelinePlugin.call(this,name,spec)}configCheckManager.prototype.run=function(timeline,spec){$(spec.configUlId).html("");timeline.plugins().forEach(function(element){if(element.obj.name){var pluginCheckBox=$('<input type="checkbox" id="'+element.obj.id+'">').attr("checked",element.enabled);$(spec.configUlId).append(pluginCheckBox).append("<li>"+element.obj.name+"</li>")}});$(spec.configUlId+" input").on("change",function(){configHandler(this.id,this.checked)});var configHandler=function(pluginId,bool){timeline.plugins().forEach(function(element){if(pluginId===element.obj.id){element.enabled=bool}});timeline()}};configCheckManager.prototype.remove=function(timeline,spec){$(this.spec.configUlId).remove()};Object.setPrototypeOf(configCheckManager.prototype,clinicalTimelinePlugin.prototype);function clinicalTimelineExporter(name,spec){clinicalTimelinePlugin.call(this,name,spec);this.id="exportTimeline"}clinicalTimelineExporter.prototype.run=function(timeline,spec){$(spec.exportDivId).css("visibility","visible");return{generateSVG:function(){$("#addtrack").css("visibility","hidden");var svg=document.querySelector(spec.timelineDiv+" svg");var serializer=new XMLSerializer;var source=serializer.serializeToString(svg);var link=document.createElement("a");if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){source=source.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"')}if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){source=source.replace(/^<svg/,'<svg xmlns:xlink="http://www.w3.org/1999/xlink"')}source='<?xml version="1.0" standalone="no"?>\r\n'+source;var url="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source);link.download="clinical-timeline.svg";link.href=url;link.click();$("#addtrack").css("visibility","visible")},generatePNG:function(download){$("#addtrack").css("visibility","hidden");var svgString=(new XMLSerializer).serializeToString(document.querySelector(spec.timelineDiv+" svg"));var canvas=document.getElementById("canvas");var ctx=canvas.getContext("2d");var DOMURL=self.URL||self.webkitURL||self;var img=new Image;var svg=new Blob([svgString],{type:"image/svg+xml;charset=utf-8"});var url=DOMURL.createObjectURL(svg);img.onload=function(){ctx.drawImage(img,0,0);var png=canvas.toDataURL("image/png");document.querySelector("#png-container").innerHTML='<img src="'+png+'"/>';var link=document.createElement("a");link.download="clinical-timeline.png";if(download){link.href=canvas.toDataURL("image/png").replace("image/png","image/octet-stream")}link.click();DOMURL.revokeObjectURL(png);link.remove()};img.src=url;$("#addtrack").css("visibility","visible")},generatePDF:function(){this.generatePNG(false);setTimeout(function(){html2canvas($("#canvas"),{onrendered:function(canvas){var canvas=document.getElementById("canvas");var imgData=canvas.toDataURL("image/png");var doc=new jsPDF("p","mm");doc.addImage(imgData,"PNG",0,0);doc.save("clinical-timeline.pdf")}})},50)}}};clinicalTimelineExporter.prototype.remove=function(timeline,spec){$(spec.exportDivId).css("visibility","hidden")};Object.setPrototypeOf(clinicalTimelineExporter.prototype,clinicalTimelinePlugin.prototype);function clinicalTimelineHelperLines(name,spec){clinicalTimelinePlugin.call(this,name,spec);this.id="helperLines"}clinicalTimelineHelperLines.prototype.run=function(timeline,spec){d3.selectAll(timeline.divId()+" [id^='timelineItem']").on("click",function(x){if(timeline.zoomFactor()===1){var helperLineGroup=d3.select(timeline.divId()+" svg").append("g").attr("class","helper-line-group"),elementXCoordinate=parseInt(this.getAttribute("x")),elementYCoordinate=parseInt(this.getAttribute("y")),elementWidth=parseInt(this.getAttribute("width")),elementHeight=parseInt(this.getAttribute("height"));helperLineGroup.append("line").attr("x1",elementXCoordinate-(x.display==="circle"?elementWidth:0)).attr("y1",elementYCoordinate+elementHeight/2).attr("x2",120).attr("y2",elementYCoordinate+elementHeight/2).attr("stroke-width",1).attr("stroke","#aaa").attr("class","helper-line x");helperLineGroup.append("line").attr("x1",elementXCoordinate).attr("y1",elementYCoordinate).attr("x2",elementXCoordinate).attr("y2",40).attr("stroke-width",1).attr("stroke","#aaa").attr("class","helper-line y");helperLineGroup.append("rect").attr("width",120).attr("height",14).attr("x",0).attr("y",elementYCoordinate-7).attr("stroke-width",2).attr("stroke","rgb(57, 106, 177)").style("fill","none");helperLineGroup.append("path").style("stroke","rgb(146, 36, 40)").style("fill","none").attr("d","M "+(elementXCoordinate-5)+" 30 L "+elementXCoordinate+" 20 L "+(elementXCoordinate+5)+" 30 Z");helperLineGroup.append("text").attr("x",this.getAttribute("x")).attr("y",40).text(timeline.formatTime(timeline.daysToTimeObject(x.starting_time),"days")).style("text-anchor","middle").style("font-size","10px");$(this).qtip("hide");setTimeout(function(){helperLineGroup.remove()},1e3)}})};Object.setPrototypeOf(clinicalTimelineHelperLines.prototype,clinicalTimelinePlugin.prototype);function clinicalTimelineOverviewAxis(name,spec){clinicalTimelinePlugin.call(this,name,spec);this.id="overviewAxis"}clinicalTimelineOverviewAxis.prototype.run=function(timeline,spec){var readOnlyVars=timeline.getReadOnlyVars(),margin=readOnlyVars.margin,overviewAxisWidth=timeline.overviewAxisWidth(),chart=readOnlyVars.chart,zoomFactor=timeline.zoomFactor(),divId=timeline.divId(),overviewSVG=d3.select(divId+" .overview"),originalZoomLevel=timeline.computeZoomLevel(readOnlyVars.minDays,readOnlyVars.maxDays,timeline.width()),overviewAxisTicks=timeline.getTickValues(readOnlyVars.minDays,readOnlyVars.maxDays,originalZoomLevel),minDayTick=overviewAxisTicks[0],maxDayTick=overviewAxisTicks[overviewAxisTicks.length-1],overViewScale=d3.time.scale().domain([clinicalTimelineUtil.roundDown(readOnlyVars.minDays,clinicalTimelineUtil.getDifferenceTicksDays(originalZoomLevel)),clinicalTimelineUtil.roundUp(readOnlyVars.maxDays,clinicalTimelineUtil.getDifferenceTicksDays(originalZoomLevel))]).range([0+margin.overviewAxis.left,overviewAxisWidth-margin.overviewAxis.right]),zoomLevel=timeline.computeZoomLevel(readOnlyVars.minDays,readOnlyVars.maxDays,timeline.width()*zoomFactor),startAllowedOverview=overViewScale(clinicalTimelineUtil.roundDown(readOnlyVars.minDays,clinicalTimelineUtil.getDifferenceTicksDays(zoomLevel)))-overViewScale(clinicalTimelineUtil.roundDown(readOnlyVars.minDays,clinicalTimelineUtil.getDifferenceTicksDays(originalZoomLevel))),endAllowedOverview=overViewScale(clinicalTimelineUtil.roundUp(readOnlyVars.maxDays,clinicalTimelineUtil.getDifferenceTicksDays(originalZoomLevel)))-overViewScale(clinicalTimelineUtil.roundUp(readOnlyVars.maxDays,clinicalTimelineUtil.getDifferenceTicksDays(zoomLevel)));var overviewBorderData=[{height:2,width:overviewAxisWidth,x:0,y:24,fill:"#ccc"},{height:2,width:overviewAxisWidth,x:0,y:44,fill:"#ccc"},{height:18,width:2,x:0,y:26,fill:"#ccc"},{height:18,width:2,x:overviewAxisWidth-2,y:26,fill:"#ccc"}];var xScaleOverview=d3.time.scale().domain([minDayTick,maxDayTick]).range([0+margin.overviewAxis.left,overviewAxisWidth-margin.overviewAxis.right]);var overviewAxis=d3.svg.axis().scale(xScaleOverview).orient("bottom").tickFormat(function(d){return timeline.formatTime(timeline.daysToTimeObject(d.valueOf()),originalZoomLevel)}).ticks(overviewAxisTicks.length).tickValues(overviewAxisTicks).tickSize(3).tickPadding(4);var overviewAxisMirror=d3.svg.axis().scale(xScaleOverview).orient("top").tickFormat(function(d){return timeline.formatTime(timeline.daysToTimeObject(d.valueOf()),originalZoomLevel)}).ticks(overviewAxisTicks.length).tickValues(overviewAxisTicks).tickSize(3).tickPadding(0);overviewSVG.style("display","initial");overviewSVG.append("g").attr("class","x axis overview-axis").attr("transform","translate(0,25)").call(overviewAxis);overviewSVG.append("g").attr("class","x axis overview-axis overview-axis-mirror").attr("transform","translate(0,44)").call(overviewAxisMirror);overviewSVG.selectAll(divId+" rect.overview-border").data(overviewBorderData).enter().append("rect").attr("height",function(d){return d.height}).attr("width",function(d){return d.width}).attr("x",function(d){return d.x}).attr("y",function(d){return d.y}).attr("fill",function(d){return d.fill}).attr("class","overview-border");var zoomedWidth=chart.width();var rectangleOverviewWidth=(overviewAxisWidth-margin.overviewAxis.left-margin.overviewAxis.right)/zoomFactor;var xScaleOverviewZoomed=d3.time.scale().domain([0,-zoomedWidth]).range([0+startAllowedOverview,overviewAxisWidth-endAllowedOverview]);var xScaleRectangle=d3.time.scale().domain([0+startAllowedOverview,overviewAxisWidth-endAllowedOverview]).range([0,-zoomedWidth]);var dragChart=d3.behavior.drag().on("drag",function(d,i){if(chart.scrolledX()){var zoomedBeginTick=xScaleOverviewZoomed(chart.scrolledX());d3.select(divId+" .overview-rectangle").attr("x",zoomedBeginTick);timeline.overviewX(zoomedBeginTick)}});var dragRectangle=d3.behavior.drag().on("drag",function(d,i){var x=parseInt(d3.select(divId+" .overview-rectangle").attr("x"))+d3.event.dx;if(x>startAllowedOverview&&x<overviewAxisWidth-rectangleOverviewWidth-endAllowedOverview&&zoomFactor>1){d3.select(divId+" svg g").attr("transform","translate("+xScaleRectangle(x)+",0)");d3.select(divId+" .overview-rectangle").attr("x",x);timeline.overviewX(x)}});var rectangleOverview=overviewSVG.append("rect").attr("height",16).attr("width",rectangleOverviewWidth).attr("x",timeline.overviewX()).attr("y",27).attr("fill","rgba(25,116,255, 0.4)").attr("class","overview-rectangle").style("cursor","move").call(dragRectangle);d3.select(divId+" svg").call(dragChart)};Object.setPrototypeOf(clinicalTimelineOverviewAxis.prototype,clinicalTimelinePlugin.prototype);function clinicalTimelinePlugin(name,spec){this.name=name;this.spec=spec||null}clinicalTimelinePlugin.prototype.run=function(timeline,spec){console.log("A plugin must have a run function to be functional")};clinicalTimelinePlugin.prototype.remove=function(timeline,spec){};function trimClinicalTimeline(name,spec){clinicalTimelinePlugin.call(this,name,spec);this.id="trimClinicalTimeline"}trimClinicalTimeline.prototype.run=function(timeline,spec){var toleranceRatio=.2,timelineElements=[],breakTimelineForKink=[],tickCoordinatesKink=[],divId=timeline.divId(),svg=d3.select(timeline.divId()+" .timeline"),maxDays=timeline.getReadOnlyVars().maxDays,minDays=timeline.getReadOnlyVars().minDays,width=timeline.width(),margin=timeline.getReadOnlyVars().margin,zoomLevel=timeline.computeZoomLevel(minDays,maxDays,width),tickValues=timeline.getTickValues(minDays,maxDays,zoomLevel),kinkLineData=[{x:75,y:0},{x:80,y:5},{x:85,y:-5},{x:90,y:5},{x:95,y:-5},{x:100,y:5},{x:105,y:-5},{x:110,y:0}],tolerance=Math.max((maxDays-minDays)*toleranceRatio,clinicalTimelineUtil.getDifferenceTicksDays(zoomLevel)),kinkLine=d3.svg.line().x(function(d){return d.x}).y(function(d){return d.y}).interpolate("linear"),tickValuesInt=tickValues.map(function(x){return Math.round(x)}),ticksToShow=[tickValuesInt[0],tickValuesInt[tickValuesInt.length-1]],expandedXAxis=d3.select(timeline.divId()+" > svg > g > g.axis");expandedXAxis.style("visibility","hidden");d3.selectAll(divId+" .timeline g rect,"+divId+" .timeline g circle").each(function(d,e){for(var i=parseInt(d.starting_time);i<=parseInt(d.ending_time);i+=clinicalTimelineUtil.getDifferenceTicksDays(zoomLevel)){if(timelineElements.indexOf(i)===-1){timelineElements.push(parseInt(i))}}});timelineElements.sort(function(a,b){return a-b});timelineElements.forEach(function(value,index){if(value>tickValuesInt[0]&&value<tickValuesInt[tickValuesInt.length-1]){for(var i=0;i<tickValuesInt.length-1;i++){if(value>=tickValuesInt[i]&&value<=tickValuesInt[i+1]){break}}if(ticksToShow.indexOf(tickValuesInt[i])===-1&&i!==tickValuesInt.length-1){ticksToShow.push(tickValuesInt[i])}if(ticksToShow.indexOf(tickValuesInt[i+1])===-1&&i!==tickValuesInt.length-1){ticksToShow.push(tickValuesInt[i+1])}}});ticksToShow.sort(function(a,b){return a-b});var prevPush=0;ticksToShow.forEach(function(item,index){if(index<ticksToShow.length-1){var first=ticksToShow[index],second=ticksToShow[index+1],toPush=index+1,noOfTicksDeletedAfterCurrentIndex=parseInt((ticksToShow[index+1]-ticksToShow[index])/clinicalTimelineUtil.getDifferenceTicksDays(zoomLevel))-1;if(noOfTicksDeletedAfterCurrentIndex===1){ticksToShow.push(Math.round((first+second)/2))}else if(second-first>tolerance){if(toPush-prevPush>1||prevPush===0&&second-first>clinicalTimelineUtil.getDifferenceTicksDays(zoomLevel)){breakTimelineForKink.push(toPush)}prevPush=toPush}}});ticksToShow.sort(function(a,b){return a-b});var xScale=d3.time.scale().domain([margin.left,width-margin.right]).range([margin.left,width-margin.right]);var shiftAtBreak=0;for(var j=0;j<ticksToShow.length;j++){if(breakTimelineForKink.indexOf(j)>-1){shiftAtBreak+=30}var breakAdjust=breakTimelineForKink.length*30;tickCoordinatesKink.push(margin.left+shiftAtBreak+j*((width-margin.right-margin.left-breakAdjust)/(ticksToShow.length-1)))}var xAxis=d3.svg.axis().scale(xScale).orient("top").tickValues(tickCoordinatesKink).tickFormat(function(d,i){return timeline.formatTime(timeline.daysToTimeObject(ticksToShow[i]),zoomLevel)});var trimmedXAxis=svg.append("g").attr("class","x axis").attr("transform","translate(0,20)").call(xAxis);var kink=svg.append("g").attr("class","kink");for(var i=0;i<ticksToShow.length;i++){if(breakTimelineForKink.indexOf(i)>-1){var kinkPosition=(tickCoordinatesKink[i-1]+tickCoordinatesKink[i])/2;kink.append("rect").attr("height",10).attr("width",35).attr("class","kink-bg").attr("x",kinkPosition-17.5).attr("y",15).attr("fill","white");kink.append("path").attr("d",kinkLine(kinkLineData)).attr("stroke","black").attr("stroke-width",1).attr("fill","none").attr("class","kink-line").attr("transform","translate("+(kinkPosition-92.5)+",20)")}}d3.selectAll(divId+" .kink-bg, "+divId+" .kink-line").style("cursor","pointer").on("click",clickHandlerKink).append("svg:title").text("Click to expand the timeline");function getXPosAdjustedForKink(pos){var first=clinicalTimelineUtil.getLowerBoundIndex(ticksToShow,pos);var second=first+1;if(second>ticksToShow.length-1){return tickCoordinatesKink[first]}return tickCoordinatesKink[first]+(pos-ticksToShow[first])*(tickCoordinatesKink[second]-tickCoordinatesKink[first])/(ticksToShow[second]-ticksToShow[first])}var diffCoordinatesPostTrim=tickCoordinatesKink[1]-tickCoordinatesKink[0],diffTicksSVGPreTrim=d3.transform(d3.select($(divId+" .axis .tick")[1]).attr("transform")).translate[0]-d3.transform(d3.select($(divId+" .axis .tick")[0]).attr("transform")).translate[0],widthMultiplier=diffCoordinatesPostTrim/diffTicksSVGPreTrim;d3.selectAll(divId+" [id^=timelineItem]").each(function(x){if(this.tagName==="circle"){d3.select(this).attr("cx",getXPosAdjustedForKink(x.starting_time)).attr("r",d3.select(this).attr("r"))}else if(this.tagName==="rect"){d3.select(this).attr("x",getXPosAdjustedForKink(x.starting_time)).attr("width",d3.select(this).attr("width")*widthMultiplier)}else{console.log("No such element as "+this)}});function clickHandlerKink(){timeline.pluginSetOrGetState("trimClinicalTimeline",false);xAxisBBox=d3.select(timeline.divId()+" > svg > g > g.axis")[0][0].getBBox();d3.select(timeline.divId()+"> svg > g").insert("rect").attr("x",xAxisBBox.x).attr("y",4).attr("width",xAxisBBox.width).attr("height",xAxisBBox.height).attr("fill","rgba(0,0,0,0)").style("cursor","pointer").on("click",function(){timeline.pluginSetOrGetState("trimClinicalTimeline",true)}).append("svg:title").text("Click to trim the timeline")}};Object.setPrototypeOf(trimClinicalTimeline.prototype,clinicalTimelinePlugin.prototype);var clinicalTimelineUtil={timelineConstants:{ALLOWED_ZOOM_LEVELS:["days","3days","10days","months","years"],DAYS_PER_YEAR:365,DAYS_PER_MONTH:30},getDifferenceTicksDays:function(zoomLevel){var diff;switch(zoomLevel){case"days":diff=1;break;case"3days":diff=3;break;case"10days":diff=10;break;case"months":diff=30;break;case"years":diff=365;break}return diff},getLowerBoundIndex:function(arr,ele){var low=0;var high=arr.length-1;while(low<high){var mid=Math.round((low+high)/2);if(arr[mid]>ele){high=mid-1}else{low=mid}}return low},roundUp:function(numToRound,multiple){var remainder=numToRound%multiple;if(multiple===0||remainder===0){return numToRound}else{if(numToRound<0){return-1*clinicalTimelineUtil.roundDown(-1*numToRound,multiple)}else{return Math.round(numToRound+multiple-remainder)}}},roundDown:function(numToRound,multiple){var remainder=numToRound%multiple;if(multiple===0||remainder===0){return numToRound}else{if(numToRound<0){return-1*clinicalTimelineUtil.roundUp(-1*numToRound,multiple)}else{return Math.round(numToRound-remainder)}}}};function clinicalTimelineVerticalLine(name,spec){clinicalTimelinePlugin.call(this,name,spec);this.id="verticalLine"}clinicalTimelineVerticalLine.prototype.run=function(timeline,spec){var divId=timeline.divId(),hoverLineGroup=d3.select(divId+" svg").append("g").attr("class","hover-line"),hoverLine=hoverLineGroup.append("line").attr("x1",0).attr("x2",0).attr("y1",20).attr("y2",268).style("stroke","#ccc"),svgHeight=d3.select(divId+" svg")[0][0].getBoundingClientRect().height,hoverText=hoverLineGroup.append("text").attr("class","hover-text").attr("y",svgHeight-10).attr("font-size",12).attr("fill","#888"),hoverBegin=spec.hoverBegin,hoverEnd=spec.hoverEnd,hoverScale=d3.time.scale().domain([hoverBegin,hoverEnd]).range([timeline.getReadOnlyVars().beginning,timeline.getReadOnlyVars().ending]),tooltipOnVerticalLine=true;hoverLineGroup.style("opacity",0);d3.select(divId+" svg").on("mousemove",function(){var hoverX=d3.mouse(this)[0];if(hoverX>hoverBegin&&hoverX<hoverEnd){hoverText.text(parseInt(hoverScale(hoverX))+"d");hoverText.attr("x",hoverX+4);hoverLine.attr("x1",hoverX).attr("x2",hoverX);hoverLineGroup.style("opacity",1);if(tooltipOnVerticalLine){$(divId+" .timeline g rect, "+divId+" .timeline g circle").each(function(index){var element=$(divId+" .timeline g rect, "+divId+" .timeline g circle")[index];var elementX=parseInt(element.getBBox().x);var elementWidth=parseInt(element.getBBox().width);var tolerance=2;if(hoverX>elementX+elementWidth/2-tolerance&&hoverX<elementX+elementWidth/2+tolerance){$(element).qtip("disable",false);$(element).qtip("show")}else{$(element).qtip("hide");$(element).qtip("disable",true)}})}}}).on("mouseout",function(){hoverLineGroup.style("opacity",0)});var tooltipControllerId=spec.tooltipControllerId;
$(tooltipControllerId).css("visibility","visible");$(tooltipControllerId+" a").on("click",function(){if(tooltipOnVerticalLine){$(tooltipControllerId+" a").text("Show tooltips on vertical-line");tooltipOnVerticalLine=false}else{$(tooltipControllerId+" a").text("Hide tooltips on vertical-line");tooltipOnVerticalLine=true}})};clinicalTimelineVerticalLine.prototype.remove=function(timeline,spec){$(spec.tooltipControllerId).css("visibility","hidden")};Object.setPrototypeOf(clinicalTimelineVerticalLine.prototype,clinicalTimelinePlugin.prototype);function clinicalTimelineZoom(name,spec){clinicalTimelinePlugin.call(this,name,spec);this.id="zoom"}clinicalTimelineZoom.prototype.run=function(timeline,spec){var readOnlyVars=timeline.getReadOnlyVars(),maxDays=readOnlyVars.maxDays,minDays=readOnlyVars.minDays,beginning=readOnlyVars.beginning,ending=readOnlyVars.ending,margin=readOnlyVars.margin,divId=timeline.divId(),width=timeline.width(),roundDown=clinicalTimelineUtil.roundDown,roundUp=clinicalTimelineUtil.roundUp,overviewAxisWidth=timeline.overviewAxisWidth(),chart=readOnlyVars.chart,svg=d3.select(divId+" svg"),g=d3.select(divId+" svg g"),gBoundingBox=g[0][0].getBoundingClientRect();if(timeline.zoomFactor()===1){var brushend=function(){var originalZoomLevel=timeline.computeZoomLevel(minDays,maxDays,width);var overViewScale=d3.time.scale().domain([roundDown(minDays,clinicalTimelineUtil.getDifferenceTicksDays(originalZoomLevel)),roundUp(maxDays,clinicalTimelineUtil.getDifferenceTicksDays(originalZoomLevel))]).range([0+margin.overviewAxis.left,overviewAxisWidth-margin.overviewAxis.right]);timeline.overviewX(overViewScale(brush.extent()[0].valueOf()));var xDaysRect=brush.extent()[0].valueOf();timeline.zoomFactor((parseInt(width)-parseInt(margin.left)-parseInt(margin.right))/parseInt(d3.select(timeline.divId()+" .extent").attr("width")));if(timeline.zoomFactor()>0){timeline.zoomFactor(Math.min(timeline.zoomFactor(),timeline.computeZoomFactor("days",minDays,maxDays,width)))}else{timeline.zoomFactor(timeline.computeZoomFactor("days",minDays,maxDays,width))}var zoomLevel=timeline.computeZoomLevel(readOnlyVars.minDays,readOnlyVars.maxDays,timeline.width()*timeline.zoomFactor());var tickValues=timeline.getTickValues(readOnlyVars.minDays,readOnlyVars.maxDays,zoomLevel);if(xDaysRect>minDays){var xZoomScale=d3.time.scale().domain([tickValues[0],tickValues[tickValues.length-1]]).range([margin.left,width*timeline.zoomFactor()-margin.right]);timeline.translateX(-xZoomScale(xDaysRect))}else{timeline.translateX(0)}$("."+divId.substr(1)+"-qtip").qtip("hide");d3.select(divId).style("visibility","hidden");timeline();d3.select(divId).style("visibility","visible");var zoomBtn=d3.select(divId+" svg").insert("text").attr("transform","translate("+(parseInt(svg.attr("width"))-70)+", "+parseInt(svg.attr("height")-5)+")").attr("class","timeline-label").text("Zoom out").style("cursor","zoom-out").attr("id","timelineZoomOut");zoomBtn.on("click",function(){timeline.zoomFactor(1);timeline.overviewX(margin.overviewAxis.left);$("."+divId.substr(1)+"-qtip").qtip("hide");d3.select(divId).style("visibility","hidden");timeline();d3.select(divId).style("visibility","visible");chart.scrolledX(null);this.remove()})};if(timeline.computeZoomLevel(minDays,maxDays,width*timeline.zoomFactor())!=="days"){var xScale=d3.time.scale().domain([beginning,ending]).range([margin.left-10,width-margin.right+10]);var brush=d3.svg.brush().x(xScale).on("brush",function(){var extent=d3.event.target.extent()}).on("brushend",brushend);var overlayBrush=g.insert("g",".axis").attr("id","overlayBrush");overlayBrush.attr("class","brush").call(brush).selectAll(divId+" .extent,"+divId+" .background,"+divId+" .resize rect").attr("height",gBoundingBox.height).attr("y",20).style("cursor","zoom-in");zoomExplanation(divId,svg,"Click + drag to zoom","hidden",120);d3.select(divId+" .background").on("mouseover",function(){d3.select(divId+" #timelineZoomExplanation").style("visibility","visible")}).on("mouseout",function(){d3.select(divId+" #timelineZoomExplanation").style("visibility","hidden")})}}else{zoomExplanation(divId,svg,"Scroll/drag to move","visible",180);d3.select(divId+" svg").style("cursor","move")}function zoomExplanation(divId,svg,text,visibility,pos){d3.select(divId+" svg").insert("text").attr("transform","translate("+(parseInt(svg.attr("width"))-pos)+", "+parseInt(svg.attr("height")-5)+")").attr("class","timeline-label").text("").attr("id","timelineZoomExplanation").text(text).style("visibility",visibility)}};Object.setPrototypeOf(clinicalTimelineZoom.prototype,clinicalTimelinePlugin.prototype);var clinicalTimeline=function(){"use strict";var allData,colorCycle=d3.scale.category20(),margin={left:200,right:30,top:15,bottom:0,overviewAxis:{left:15,right:15}},itemHeight=6,itemMargin=8,divId=null,width=null,zoomFactor=1,postTimelineHooks=[],stackSlack=null,translateX=0,beginning=0,ending=0,minDays=0,maxDays=0,overviewAxisWidth=0,enableTrackTooltips,overviewX=margin.overviewAxis.left,chart=null,clinicalTimelinePlugins,clinicalTimelineReadOnlyVars;function getTrack(data,track){return data.filter(function(x){return x.label.trim()===track.trim()})[0]}function timeline(){var visibleData=allData.filter(function(x){return x.visible});maxDays=Math.max(getMaxEndingTime(allData),1);if(stackSlack===null){if(maxDays>300){stackSlack=5}if(maxDays>600){stackSlack=10}if(maxDays>900){stackSlack=20}}minDays=Math.min(getMinStartingTime(allData),0);var zoomLevel=timeline.computeZoomLevel(minDays,maxDays,width*zoomFactor),tickValues=timeline.getTickValues(minDays,maxDays,zoomLevel);beginning=tickValues[0];ending=tickValues[tickValues.length-1];overviewAxisWidth=width-200;var chart=d3.timeline().stack().margin(margin).tickFormat({format:function(d){return timeline.formatTime(timeline.daysToTimeObject(d.valueOf()),zoomLevel)},tickValues:timeline.getTickValues(minDays,maxDays,zoomLevel),tickSize:6}).translate(translateX).width(width*zoomFactor).beginning(String(beginning)).ending(ending).stackSlack(stackSlack).orient("top").itemHeight(itemHeight).itemMargin(itemMargin).colors(colorCycle);$(divId).html("");var svg=d3.select(divId).append("svg").attr("width",width).attr("class","timeline");svg.append("rect").attr("width","100%").attr("height","100%").attr("fill","white");svg.append("defs").html(""+'<filter id="dropshadow" x="0" y="0" width="200%" height="200%">'+'  <feOffset result="offOut" in="SourceAlpha" dx="1.5" dy="1.5" />'+'  <feGaussianBlur result="blurOut" in="offOut" stdDeviation="1" />'+'  <feBlend in="SourceGraphic" in2="blurOut" mode="normal" />'+"</filter>");svg.datum(mergeAllTooltipTablesAtEqualTimepoint(visibleData)).call(chart);$(divId+" [id^='timelineItem']").each(function(){timeline.addDataPointTooltip($(this))});$(divId+" [id^='timelineItem']").each(function(){$(this).on({mouseover:function(){modifyTimelineElementsSize(this,2)},mouseout:function(){modifyTimelineElementsSize(this,-2)}})});if(enableTrackTooltips){$(divId+" .timeline-label").each(function(i){if($(this).prop("__data__")[i].split&&!$(this).prop("__data__")[i].parent_track){addSplittedTrackTooltip($(this),allData)}else{addTrackTooltip($(this),allData)}});svg.attr("height",parseInt(svg.attr("height"))+15);svg.insert("text").attr("transform","translate(0,"+svg.attr("height")+")").attr("class","timeline-label").text("Add track").attr("id","addtrack");addNewTrackTooltip($("#addtrack"))}svg.insert("text").attr("transform","translate(0, 15)").attr("class","timeline-label").text("Time since diagnosis");d3.select(divId+" .axis").attr("transform","translate(0,20)");$(divId+" .timeline-label").each(function(i,x){x.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:space","preserve")});d3.select(divId+" svg").insert("rect",".timeline-label").attr("width",130).attr("height",svg.attr("height")).attr("x",0).attr("y",0).style("fill","rgb(255, 255, 255)");$(divId+" [id^='timelineItem']").css("cursor","pointer");var overviewSVG=d3.select(divId).append("svg").attr("height",75).attr("width",overviewAxisWidth).attr("class","overview").style("display","none");clinicalTimelineReadOnlyVars={beginning:beginning,ending:ending,minDays:minDays,maxDays:maxDays,margin:margin,chart:chart};clinicalTimelinePlugins.forEach(function(element){var plugin=element.obj;if(plugin.run instanceof Function&&element.enabled){plugin.run(timeline,element.obj.spec)}else if(!plugin.enabled){plugin.remove(timeline,element.obj.spec)}});postTimelineHooks.forEach(function(hook){hook.call()})}function modifyTimelineElementsSize(element,change){$(element).attr("r",parseInt($(element).attr("r"))+change);$(element).attr("height",parseInt($(element).attr("height"))+change)}function isDurationTrack(trackData){var isDuration=false;trackData.times.forEach(function(x){if(parseInt(x.starting_time)!==parseInt(x.ending_time)){isDuration=true}});return isDuration}function splitTooltipTables(trackData){var expandedTimes=[];for(var i=0;i<trackData.times.length;i++){var t=trackData.times[i];if(t.tooltip_tables.length>1){for(var j=0;j<t.tooltip_tables.length;j++){expandedTimes=expandedTimes.concat({starting_time:t.starting_time,ending_time:t.ending_time,display:"circle",tooltip_tables:[t.tooltip_tables[j]]})}}else{expandedTimes=expandedTimes.concat(t)}}trackData.times=expandedTimes}function mergeTooltipTablesAtEqualTimepoint(trackData){if(!trackData||trackData.times.length===0)return;var collapsedTimes=[],group=[],startingTime;var sortedTimes=trackData.times.sort(function(a,b){return parseInt(a.starting_time)-parseInt(b.starting_time)});var mergeTimepoints=function(startingTime,group){if(group.length===1){return group[0]}else{return{starting_time:startingTime,ending_time:startingTime,display:"dropshadow circle",tooltip_tables:_.reduce(group.map(function(x){return x.tooltip_tables}),function(a,b){return a.concat(b)},[])}}};for(var i=0;i<sortedTimes.length;i++){var t=sortedTimes[i];if(parseInt(t.starting_time)===startingTime){group=group.concat(t)}else{if(group.length>0){collapsedTimes=collapsedTimes.concat(mergeTimepoints(startingTime,group))}group=[t];startingTime=parseInt(t.starting_time)}}collapsedTimes=collapsedTimes.concat(mergeTimepoints(startingTime,group));trackData.times=collapsedTimes}function mergeAllTooltipTablesAtEqualTimepoint(data){var collapsedTracks=data.filter(function(trackData){return trackData.collapse&&!isDurationTrack(trackData)});collapsedTracks.forEach(mergeTooltipTablesAtEqualTimepoint);return data}function getClinicalAttributes(data,track){return _.union.apply(_,getTrack(data,track).times.map(function(x){return _.union.apply(_,x.tooltip_tables.map(function(y){return y.map(function(z){return z[0]})}))}))}function groupByClinicalAttribute(track,attr){return _.groupBy(getTrack(allData,track).times,function(x){if(x.tooltip_tables.length===1){return _.reduce(x.tooltip_tables[0],function(a,b){a[b[0]]=b[1];return a},{})[attr]}else{return undefined}})}function splitByClinicalAttributes(track,attrs){if(typeof attrs==="string"){attrs=[attrs]}var split_tracks=[track],tracks;for(var i=0;i<attrs.length;i++){var attr=attrs[i];tracks=[];for(var j=0;j<split_tracks.length;j++){tracks=tracks.concat(splitByClinicalAttribute(split_tracks[j],attr))}split_tracks=tracks}}function splitByClinicalAttribute(track,attr){splitTooltipTables(getTrack(allData,track));var g=groupByClinicalAttribute(track,attr);if("undefined"in g){return[]}var trackIndex=_.findIndex(allData,function(x){return x.label===track});var indent=allData[trackIndex].split?track.match(new RegExp("^ *"))[0]:"";indent+="    ";allData=allData.filter(function(x){return x.label!==track});allData.splice(trackIndex,0,{label:track,times:[],visible:true,split:true});var attrValues=_.sortBy(Object.keys(g),function(k){return _.min(_.pluck(g[k],"starting_time"))});for(var j=0;j<attrValues.length;j++){allData.splice(trackIndex+j+1,0,{label:indent+attrValues[j],times:g[attrValues[j]],visible:true,split:true,parent_track:track})}return attrValues.map(function(x){return indent+x})}function unSplitTrack(track){var trackData=allData.filter(function(x){return $.trim(x.label)===$.trim(track)&&x.split})[0];var times=allData.filter(function(x){return x.split&&x.parent_track===track}).reduce(function(a,b){return a.concat(b.times)},[]);trackData.times=times;trackData.visible=true;trackData.label=track;delete trackData.split;allData=allData.filter(function(x){return!(x.split&&x.parent_track===track)});timeline()}function sizeByClinicalAttribute(track,attr,minSize,maxSize){var arr=getTrack(allData,track).times.map(function(x){if(x.tooltip_tables.length===1){return parseFloat(String(x.tooltip_tables[0].filter(function(x){return x[0]===attr})[0][1]).replace(/[^\d.-]/g,""))}else{return undefined}});var scale=d3.scale.linear().domain([d3.min(arr),d3.max(arr)]).range([minSize,maxSize]);getTrack(allData,track).times.forEach(function(x){if(x.tooltip_tables.length===1){x.size=scale(parseFloat(String(x.tooltip_tables[0].filter(function(x){return x[0]===attr})[0][1]).replace(/[^\d.-]/g,"")))||minSize}})}function colorByClinicalAttribute(track,attr){var g=groupByClinicalAttribute(track,attr);Object.keys(g).forEach(function(k){g[k].forEach(function(x){x.color=colorCycle(k)})})}function clearColors(track){var times=getTrack(allData,track).times;for(var i=0;i<times.length;i++){if("color"in times[i]){delete times[i].color}}}timeline.addDataPointTooltip=function addDataPointTooltip(elem){function createDataTable(tooltip_table){var dataTable={sDom:"t",bJQueryUI:true,bDestroy:true,aaData:tooltip_table,aoColumnDefs:[{aTargets:[0],sClass:"left-align-td",mRender:function(data,type,full){return"<b>"+data+"</b>"}},{aTargets:[1],sClass:"left-align-td",bSortable:false}],fnDrawCallback:function(oSettings){$(oSettings.nTHead).hide()},aaSorting:[]};return dataTable}elem.qtip({content:{text:"table"},events:{render:function(event,api){var tooltipDiv=$.parseHTML("<div></div>"),d=elem.prop("__data__"),table;if("tooltip_tables"in d){for(var i=0;i<d.tooltip_tables.length;i++){if(i!==0){$(tooltipDiv).append("<hr />")}table=$.parseHTML("<table style='text-align:left; background-color: white;'></table>");$(table).dataTable(createDataTable(d.tooltip_tables[i]));$(tooltipDiv).append(table)}}else if("tooltip"in d){table=$.parseHTML("<table style='text-align:left; background-color: white;'></table>");$(table).dataTable(createDataTable(d.tooltip));$(tooltipDiv).append(table)}$(this).html(tooltipDiv);$(this).addClass(divId.substr(1)+"-qtip");api.elements.target.click(function(e){if(api.wasClicked){api.hide();api.wasClicked=false}else{api.wasClicked=!api.wasClicked}})},hide:function(event,api){if(api.wasClicked&&event.originalEvent.type==="mouseleave"||!api.wasClicked&&event.originalEvent.type==="click"){try{event.preventDefault()}catch(e){console.log(e.message)}}}},show:{event:"mouseover"},hide:{event:"mouseleave"},style:{classes:"qtip-light qtip-rounded qtip-wide"},position:{my:"top middle",at:"bottom middle",viewport:$(window)}})};function toggleTrackVisibility(trackName){var trackData=getTrack(allData,trackName);trackData.visible=trackData.visible?false:true}function toggleTrackCollapse(trackName){var trackData=getTrack(allData,trackName);if(trackData.collapse){trackData.collapse=false;splitTooltipTables(trackData)}else{if(!isDurationTrack(trackData)){trackData.collapse=true}}}function addNewTrackTooltip(elem){elem.qtip({content:{text:"addtrack"},events:{render:function(event,api){invisibleTracks=allData.filter(function(x){return!x.visible});if(invisibleTracks.length===0){$(this).html("All tracks shown")}else{var trackAnchors="";for(var i=0;i<invisibleTracks.length;i++){trackAnchors+="<a href='#' onClick='return false' class='show-track'>"+invisibleTracks[i].label+"</a><br />"}$(this).html(trackAnchors);$(".show-track").each(function(){$(this).on("click",function(){toggleTrackVisibility($(this).prop("innerHTML"));$(this).remove();timeline()})})}}},show:{event:"mouseover"},hide:{fixed:true,delay:0,event:"mouseout"},style:{classes:"qtip-light qtip-rounded qtip-wide"},position:{my:"top middle",at:"top middle",viewport:$(window)}})}function addClinicalAttributesTooltip(elem,track,clickHandlerType){function colorClickHandler(){colorByClinicalAttribute(track,$(this).prop("innerHTML"));timeline()}function splitClickHandler(){splitByClinicalAttributes(track,$(this).prop("innerHTML"));timeline()}function sizeByClickHandler(){sizeByClinicalAttribute(track,$(this).prop("innerHTML"),2,itemHeight);timeline()}elem.qtip({content:{text:""},events:{render:function(event,api){if(clickHandlerType==="color"){clickHandler=colorClickHandler}else if(clickHandlerType==="split"){clickHandler=splitClickHandler}else if(clickHandlerType==="size"){clickHandler=sizeByClickHandler}else{console.log("Unknown clickHandler for clinical attributes tooltip.")}var colorByAttribute=$.parseHTML("<div class='color-by-attr-tooltip'></div>");var clinAtts=getClinicalAttributes(allData,track);for(var i=0;i<clinAtts.length;i++){var a=$.parseHTML("<a href='#' onClick='return false'>"+clinAtts[i]+"</a>");$(a).on("click",clickHandler);$(colorByAttribute).append(a);$(colorByAttribute).append("<br />")}$(this).html(colorByAttribute)}},show:{event:"click"},hide:{fixed:true,delay:0,event:"mouseout"},style:{classes:"qtip-light qtip-rounded qtip-wide"},position:{my:"left middle",at:"top middle",viewport:$(window)}})}function addSplittedTrackTooltip(elem,data){function unSplitClickHandler(trackName){return function(){unSplitTrack(trackName)}}elem.qtip({content:{text:"track"},events:{render:function(event,api){var trackTooltip=$.parseHTML("<div class='track-toolip'></div>");var a=$.parseHTML("<a href='#' onClick='return false' class='hide-track'>Unsplit</a>");$(a).on("click",unSplitClickHandler(elem.prop("innerHTML").split(".")[0]));$(trackTooltip).append(a);$(this).html(trackTooltip)}},show:{event:"mouseover"},hide:{fixed:true,delay:0,event:"mouseout"},style:{classes:"qtip-light qtip-rounded qtip-wide"},position:{my:"top middle",at:"top middle",viewport:$(window)}})}function addTrackTooltip(elem,data){function hideTrackClickHandler(trackName){return function(){toggleTrackVisibility(trackName);timeline()}}function collapseTrackClickHandler(trackName){return function(){toggleTrackCollapse(trackName);timeline()}}elem.qtip({content:{text:"track"},events:{render:function(event,api){var trackTooltip=$.parseHTML("<div class='track-toolip'></div>");var a=$.parseHTML("<a href='#' onClick='return false' class='hide-track'>Hide "+elem.prop("innerHTML")+"</a>");$(a).on("click",hideTrackClickHandler(elem.prop("innerHTML")));$(trackTooltip).append(a);$(trackTooltip).append("<br />");if(!isDurationTrack(getTrack(allData,elem.prop("innerHTML")))){a=$.parseHTML("<a href='#' onClick='return false' class='hide-track'>Collapse/Stack</a>");$(a).on("click",collapseTrackClickHandler(elem.prop("innerHTML")));$(trackTooltip).append(a);$(trackTooltip).append("<br />")}var colorBy=$.parseHTML("<a href='#' onClick='return false' class='color-by-attr'>Color by</a>");$(trackTooltip).append(colorBy);var clearColorsA=$.parseHTML("&nbsp;<a href='#' onClick='return false'>Clear</a>");$(clearColorsA).on("click",function(){clearColors(elem.prop("innerHTML"));timeline()});$(trackTooltip).append(clearColorsA);$(trackTooltip).append("<br />");var splitBy=$.parseHTML("<a href='#' onClick='return false' class='split-by-attr'>Split by</a>");$(trackTooltip).append(splitBy);$(trackTooltip).append("<br />");var sizeBy=$.parseHTML("<a href='#' onClick='return false' class='split-by-attr'>Size by</a>");$(trackTooltip).append(sizeBy);$(this).html(trackTooltip);addClinicalAttributesTooltip($(colorBy),elem.prop("innerHTML"),"color");addClinicalAttributesTooltip($(splitBy),elem.prop("innerHTML"),"split");addClinicalAttributesTooltip($(sizeBy),elem.prop("innerHTML"),"size")}},show:{event:"mouseover"},hide:{fixed:true,delay:0,event:"mouseout"},style:{classes:"qtip-light qtip-rounded qtip-wide"},position:{my:"top middle",at:"top middle",viewport:$(window)}})}function filterTrack(data,track){return data.filter(function(x){return x.label!==track})}function getMaxEndingTime(data){return Math.max.apply(Math,data.map(function(o){return Math.max.apply(Math,o.times.map(function(t){return t.ending_time||0}))}))}function getMinStartingTime(data){return Math.min.apply(Math,data.map(function(o){return Math.min.apply(Math,o.times.map(function(t){return t.starting_time}))}))}timeline.daysToTimeObject=function(dayCount){var time={},daysPerYear=clinicalTimelineUtil.timelineConstants.DAYS_PER_YEAR,daysPerMonth=clinicalTimelineUtil.timelineConstants.DAYS_PER_MONTH;time.daysPerYear=daysPerYear;time.daysPerMonth=daysPerMonth;time.y=dayCount>0?Math.floor(dayCount/daysPerYear):Math.ceil(dayCount/daysPerYear);time.m=dayCount>0?Math.floor(dayCount%daysPerYear/daysPerMonth):Math.ceil(dayCount%daysPerYear/daysPerMonth);time.d=Math.floor(dayCount%daysPerYear%daysPerMonth);time.toDays=function(){return time.y*time.daysPerYear+time.m*time.daysPerMonth+time.d};time.toMonths=function(){return time.y*12+time.m+time.d/daysPerMonth};time.toYears=function(){return time.y+time.m/12+time.d/daysPerYear};return time};timeline.formatTime=function(time,zoomLevel){var dayFormat=[],d,m,y;if(clinicalTimelineUtil.timelineConstants.ALLOWED_ZOOM_LEVELS.indexOf(zoomLevel)>-1){if(time.y===0&&time.m===0&&time.d===0){dayFormat="0"}else{switch(zoomLevel){case"days":case"3days":case"10days":d=time.toDays();dayFormat=d+"d";break;case"months":m=time.m+12*time.y;dayFormat=m+"m";break;case"years":y=time.y;dayFormat=y+"y";break}}}else{console.log("Undefined zoomLevel")}return dayFormat};timeline.computeZoomLevel=function(minDays,maxDays,width){var pixelsPerDay=parseFloat(parseInt(width)/difference(parseInt(minDays),parseInt(maxDays)));if(pixelsPerDay<1){return"years"}else if(pixelsPerDay<10){return"months"}else if(pixelsPerDay<25){return"10days"}else if(pixelsPerDay<50){return"3days"}else{return"days"}};timeline.computeZoomFactor=function(zoomLevel,minDays,maxDays,width){switch(zoomLevel){case"years":return.9*difference(parseInt(minDays),parseInt(maxDays))/parseInt(width);case"months":return 19*difference(parseInt(minDays),parseInt(maxDays))/parseInt(width);case"10days":return 34*difference(parseInt(minDays),parseInt(maxDays))/parseInt(width);case"3days":return 49*difference(parseInt(minDays),parseInt(maxDays))/parseInt(width);case"days":return 51*difference(parseInt(minDays),parseInt(maxDays))/parseInt(width);default:throw"Undefined zoomLevel: "+zoomLevel}};function roundUpDays(dayCount,zoomLevel){var time=timeline.daysToTimeObject(dayCount),rv,additive=dayCount<0?1:-1;switch(zoomLevel){case"years":rv=(time.y+additive)*time.daysPerYear;break;case"months":rv=time.y*time.daysPerYear+(time.m+additive)*time.daysPerMonth;rv+=Math.abs(time.m)===11?(time.daysPerYear-12*time.daysPerMonth)*additive:0;break;case"3days":rv=time.toDays()+time.d%3*additive;break;default:rv=dayCount;break}return rv}function difference(a,b){return Math.max(a,b)-Math.min(a,b)}timeline.getTickValues=function(minDays,maxDays,zoomLevel){var tickValues=[],maxTime=timeline.daysToTimeObject(parseInt(maxDays)),minTime=timeline.daysToTimeObject(parseInt(minDays)),roundDown=clinicalTimelineUtil.roundDown,roundUp=clinicalTimelineUtil.roundUp;var i;if(zoomLevel==="years"){for(i=roundDown(minTime.toYears(),1);i<=roundUp(maxTime.toYears(),1);i++){tickValues.push(i*maxTime.daysPerYear)}}else if(zoomLevel==="months"){for(i=roundDown(minTime.toMonths(),1);i<=roundUp(maxTime.toMonths(),1);i++){tickValues.push(i*maxTime.daysPerMonth+parseInt(i/12)*5)}}else if(zoomLevel==="10days"){for(i=roundDown(minTime.toDays(),10);i<=roundUp(maxTime.toDays(),10);i+=10){tickValues.push(i)}}else if(zoomLevel==="3days"){for(i=roundDown(minTime.toDays(),3);i<=roundUp(maxTime.toDays(),3);i+=3){tickValues.push(i)}}else{for(i=minTime.toDays();i<=maxTime.toDays();i++){tickValues.push(i)}}return tickValues};timeline.enableTrackTooltips=function(b){if(!arguments.length)return enableTrackTooltips;enableTrackTooltips=b;return timeline};timeline.width=function(w){if(!arguments.length)return width;width=w;return timeline};timeline.overviewAxisWidth=function(w){if(!arguments.length)return overviewAxisWidth;overviewAxisWidth=w;return timeline};timeline.stackSlack=function(){if(!arguments.length)return stackSlack;return timeline};timeline.data=function(data){if(!arguments.length)return allData;allData=data;return timeline};timeline.divId=function(name){if(!arguments.length)return divId;divId=name;return timeline};timeline.plugins=function(plugins){if(!arguments.length)return clinicalTimelinePlugins;clinicalTimelinePlugins=plugins;return timeline};timeline.pluginSetOrGetState=function(pluginId,state){clinicalTimelinePlugins.forEach(function(element,index){if(element.obj.id===pluginId){if(typeof state!=="boolean"){return element.enabled}else{element.enabled=state;timeline()}}})};timeline.zoomFactor=function(zFactor){if(!arguments.length)return zoomFactor;zoomFactor=zFactor};timeline.overviewX=function(x){if(!arguments.length)return overviewX;overviewX=x};timeline.translateX=function(x){if(!arguments.length)return translateX;translateX=x};timeline.getReadOnlyVars=function(){return clinicalTimelineReadOnlyVars};timeline.collapseAll=function(){var singlePointTracks=allData.filter(function(trackData){return!isDurationTrack(trackData)});singlePointTracks.forEach(mergeTooltipTablesAtEqualTimepoint);singlePointTracks.forEach(function(x){x.collapse=true});return timeline};timeline.orderTracks=function(labels){if(!arguments.length){allData=_.sortBy(allData,"label");return timeline}var data=[];var track;for(var i=0;i<labels.length;i++){track=getTrack(allData,labels[i]);if(track){data=data.concat(track)}}data=data.concat(_.sortBy(allData.filter(function(x){return labels.indexOf(x.label)===-1}),"label"));allData=data;return timeline};timeline.orderTrackTooltipTables=function(track,rowkeys){var trackData=getTrack(allData,track);if(trackData.times.length===0){return timeline}var alphaSortRows=_.uniq(trackData.times.map(function(t){return t.tooltip_tables.map(function(tt){return tt.map(function(row){if(rowkeys.indexOf(row[0])===-1)return row[0]})})}).reduce(function(a,b){return a.concat(b)},[]).reduce(function(a,b){return a.concat(b)},[])).sort();var allLabelRows;if(alphaSortRows&&alphaSortRows[0]){allLabelRows=rowkeys.concat(alphaSortRows)}else{allLabelRows=rowkeys}trackData.times.forEach(function(t){for(var i=0;i<t.tooltip_tables.length;i++){var tt=t.tooltip_tables[i],sortTt=[];for(var j=0;j<allLabelRows.length;j++){var row=tt.filter(function(x){return x[0]===allLabelRows[j]})[0];if(row){sortTt=sortTt.concat([row])}}t.tooltip_tables[i]=sortTt}});return timeline};timeline.orderAllTooltipTables=function(rowkeys){allData.forEach(function(track){timeline.orderTrackTooltipTables(track.label,rowkeys)});return timeline};timeline.splitByClinicalAttributes=function(track,attrs){var trackData=getTrack(allData,track);if(trackData){splitByClinicalAttributes(track,attrs)}return timeline};timeline.sizeByClinicalAttribute=function(track,attr){var trackData=getTrack(allData,track);if(trackData){var attrData=trackData.times[0].tooltip_tables[0].filter(function(x){return x[0]===attr});if(attrData.length===1){sizeByClinicalAttribute(track,attr,2,itemHeight)}}return timeline};timeline.toggleTrackCollapse=function(track){var trackData=getTrack(allData,track);if(trackData){toggleTrackCollapse(track)}return timeline};timeline.setTimepointsDisplay=function(track,display){var trackData=getTrack(allData,track);if(trackData){trackData.times.forEach(function(x){if(x.tooltip_tables.length===1){x.display=display}})}return timeline};timeline.addPostTimelineHook=function(hook){postTimelineHooks=postTimelineHooks.concat(hook);return timeline};return timeline};var clinicalTimelineParser=function(){function transformToTimelineJSON(clinical_timeline_data){var transformToTrack=function(clin_events){var track={label:capitalizeFirstLetterLowerCaseRest(clin_events[0].eventType),visible:true,times:[]};clin_events.forEach(function(x){var timepoint={starting_time:x.startDate,ending_time:x.stopDate!==null?x.stopDate:x.startDate,display:x.stopDate!==null?"rect":"circle",tooltip_tables:[Object.keys(x.eventData).map(function(k){return[k,x.eventData[k]]})]};timepoint.tooltip_tables[0].push(["START_DATE",x.startDate]);if(x.stopDate!==null){timepoint.tooltip_tables[0].push(["STOP_DATE",x.stopDate])}track.times.push(timepoint)});return track};var g=_.groupBy(clinical_timeline_data,"eventType");var tracks=[];_.each(g,function(x){tracks.push(transformToTrack(x))});return tracks}function capitalizeFirstLetterLowerCaseRest(string){return string.charAt(0).toUpperCase()+string.slice(1).toLowerCase()}return transformToTimelineJSON}();var clinicalTimelineSanityChecker=function(){function validateData(data){for(var i=0;i<data.length;i++){validateTrack(data[i])}}function validateTrack(track){required_track_attrs=["label","times","visible"];for(var i=0;i<required_track_attrs.length;i++){if(!(required_track_attrs[i]in track)){throw required_track_attrs[i]+" not in track"}}validateTimes(track.times)}function validateTimes(times){for(var i=0;i<times.length;i++){validateTime(times[i])}}function validateTime(time){return validateTooltipTables(time.tooltip_tables)}function validateTooltipTables(tooltip_tables){for(var i=0;i<tooltip_tables.length;i++){validateTooltipTable(tooltip_tables[i])}}function validateTooltipTable(tooltip_table){if(tooltip_table){for(var i=0;i<tooltip_table.length;i++){if(!tooltip_table[i]){throw"tooltip_table err missing array: "+tooltip_table[i]}if(tooltip_table[i].length!==2){throw"tooltip_table err expected array of key and value pair: "+tooltip_table[i]}}}else{throw"tooltip_table err no table: "+tooltip_table}}return validateData}();

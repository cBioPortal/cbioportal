<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cbioportal.persistence.mybatis.GeneMapper">

    <sql id="select">
        gene.entrez_gene_id AS "${prefix}entrezGeneId",
        gene.hugo_gene_symbol AS "${prefix}hugoGeneSymbol"
        <if test="projection == 'SUMMARY' || projection == 'DETAILED'">
            ,
            gene.type AS "${prefix}type"
        </if>
    </sql>

    <sql id="from">
        FROM gene
        <if test="alias != null">
            INNER JOIN gene_alias ON gene.entrez_gene_id = gene_alias.entrez_gene_id
        </if>
    </sql>

    <sql id="where">
        <where>
            <if test="alias != null">
                gene_alias.gene_alias = #{alias}
            </if>
            <if test="keyword != null">
                <foreach item="item" collection="keyword.split(' ')" open="(" separator=") AND (" close=")">
                    gene.hugo_gene_symbol like CONCAT('%', #{item}, '%')
                </foreach>
            </if>
        </where>
    </sql>

    <select id="getGenes" resultType="org.cbioportal.model.Gene">
        SELECT
        <include refid="select">
            <property name="prefix" value=""/>
        </include>
        <include refid="from"/>
        <include refid="where"/>
        <if test="sortBy != null and projection != 'ID' and keyword == null">
            ORDER BY "${sortBy}" ${direction}
        </if>
        <if test="projection == 'ID' and keyword == null">
            ORDER BY gene.entrez_gene_id ASC
        </if>
        <if test="keyword != null">
            ORDER BY CASE WHEN gene.hugo_gene_symbol LIKE CONCAT(#{keyword}, '%') THEN 0 ELSE 1 END, gene.hugo_gene_symbol
        </if>
        <if test="limit != null and limit != 0">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <select id="getMetaGenes" resultType="org.cbioportal.model.meta.BaseMeta">
        SELECT
        COUNT(*) AS "totalCount"
        <include refid="from"/>
        <include refid="where"/>
    </select>

    <select id="getGeneByGeneticEntityId" resultType="org.cbioportal.model.Gene">
        SELECT
        <include refid="select">
            <property name="prefix" value=""/>
        </include>
        FROM gene
        WHERE gene.genetic_entity_id = #{geneticEntityId}
    </select>

    <select id="getGeneByEntrezGeneId" resultType="org.cbioportal.model.Gene">
        SELECT
        <include refid="select">
            <property name="prefix" value=""/>
        </include>
        FROM gene
        WHERE gene.entrez_gene_id = #{entrezGeneId}
    </select>

    <select id="getGeneByHugoGeneSymbol" resultType="org.cbioportal.model.Gene">
        SELECT
        <include refid="select">
            <property name="prefix" value=""/>
        </include>
        FROM gene
        WHERE gene.hugo_gene_symbol = #{hugoGeneSymbol}
    </select>

    <select id="getAliasesOfGeneByEntrezGeneId" resultType="string">
        SELECT gene_alias.gene_alias
        FROM gene_alias
        WHERE gene_alias.entrez_gene_id = #{entrezGeneId}
    </select>

    <select id="getAliasesOfGeneByHugoGeneSymbol" resultType="string">
        SELECT gene_alias.gene_alias
        FROM gene_alias
            INNER JOIN gene ON gene_alias.entrez_gene_id = gene.entrez_gene_id
        WHERE gene.hugo_gene_symbol = #{hugoGeneSymbol}
    </select>

    <select id="getAllAliases" resultType="org.cbioportal.model.GeneAlias">
        SELECT
        gene_alias.entrez_gene_id AS "entrezGeneId",
        LOWER(gene_alias.gene_alias) AS "geneAlias"
        FROM gene_alias
    </select>

    <select id="getGenesByEntrezGeneIds" resultType="org.cbioportal.model.Gene">
        SELECT
        <include refid="select">
            <property name="prefix" value=""/>
        </include>
        FROM gene
        <where>
            <if test="entrezGeneIds != null and !entrezGeneIds.isEmpty()">
                gene.entrez_gene_id IN
                <foreach item="item" collection="entrezGeneIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="entrezGeneIds == null or entrezGeneIds.isEmpty()">
                FALSE
            </if>
        </where>
    </select>

    <select id="getMetaGenesByEntrezGeneIds" resultType="org.cbioportal.model.meta.BaseMeta">
        SELECT
        COUNT(*) AS "totalCount"
        FROM gene
        <where>
            <if test="list != null and !list.isEmpty()">
                gene.entrez_gene_id IN
                <foreach item="item" collection="list" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="list == null or list.isEmpty()">
                FALSE
            </if>
        </where>
    </select>

    <select id="getGenesByHugoGeneSymbols" resultType="org.cbioportal.model.Gene">
        SELECT
        <include refid="select">
            <property name="prefix" value=""/>
        </include>
        FROM gene
        <where>
            <if test="hugoGeneSymbols != null and !hugoGeneSymbols.isEmpty()">
                gene.hugo_gene_symbol IN
                <foreach item="item" collection="hugoGeneSymbols" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="hugoGeneSymbols == null or hugoGeneSymbols.isEmpty()">
                FALSE
            </if>
        </where>
    </select>

    <select id="getMetaGenesByHugoGeneSymbols" resultType="org.cbioportal.model.meta.BaseMeta">
        SELECT
        COUNT(*) AS totalCount
        FROM gene
        <where>
            <if test="list != null and !list.isEmpty()">
                gene.hugo_gene_symbol IN
                <foreach item="item" collection="list" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="list == null or list.isEmpty()">
                FALSE
            </if>
        </where>
    </select>

</mapper>

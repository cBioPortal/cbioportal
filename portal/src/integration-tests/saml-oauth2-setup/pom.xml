<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>org.mskcc.cbio</groupId>
    <artifactId>saml-oauth2-setup</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <packaging>pom</packaging>

    <modules>
        <module>saml-idp</module>
    </modules>

    <dependencies>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.12</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.mock-server</groupId>
            <artifactId>mockserver-netty</artifactId>
            <version>5.8.0</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.mock-server</groupId>
            <artifactId>mockserver-client-java</artifactId>
            <version>5.8.0</version>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.5.1</version>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                    <compilerArgs>
                        <arg>-parameters</arg>
                    </compilerArgs>
                </configuration>
                <executions>
                    <execution>
                        <goals>
                            <goal>testCompile</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.codehaus.cargo</groupId>
                <artifactId>cargo-maven2-plugin</artifactId>
                <version>1.7.8</version>
                <configuration>
                    <container>
                        <containerId>tomcat8x</containerId>
                        <type>embedded</type>
                        <systemProperties>
                            <authenticate>saml</authenticate>
                            <dat.method>oauth2</dat.method>
                            <!-- DB settings -->
                            <db.user>${env.CBIO_TEST_DB_USR}</db.user>
                            <db.password>${env.CBIO_TEST_DB_PSW}</db.password>
                            <db.host>${env.CBIO_TEST_DB_HOST}</db.host>
                            <db.portal_db_name>${env.CBIO_TEST_DB_NAME}</db.portal_db_name>
                            <db.connection_string>${env.CBIO_TEST_DB_CONNECTION_STRING}</db.connection_string>
                            <!-- SAML settings -->
                            <saml.keystore.location>file://${project.basedir}/testSamlKeystore.jks
                            </saml.keystore.location>
                            <saml.keystore.password>123456</saml.keystore.password>
                            <saml.keystore.private-key.key>secure-key</saml.keystore.private-key.key>
                            <saml.keystore.private-key.password>654321</saml.keystore.private-key.password>
                            <saml.keystore.default-key>secure-key</saml.keystore.default-key>

                            <saml.idp.metadata.location>file://${project.basedir}/saml-idp-metadata.xml
                            </saml.idp.metadata.location>
                            <!--I had to use specificBinding because of this bug https://github.com/spring-projects/spring-security-saml/issues/460 -->
                            <saml.idp.comm.binding.settings>specificBinding</saml.idp.comm.binding.settings>
                            <saml.idp.comm.binding.type>bindings:HTTP-Redirect</saml.idp.comm.binding.type>
                            <saml.sp.metadata.entitybaseurl>#{null}</saml.sp.metadata.entitybaseurl>
                            <saml.sp.metadata.entityid>cbioportal</saml.sp.metadata.entityid>
                            <saml.idp.metadata.entityid>spring.security.saml.idp.id</saml.idp.metadata.entityid>
                            <saml.idp.metadata.attribute.email>User.email</saml.idp.metadata.attribute.email>
                            <saml.custom.userservice.class>
                                org.cbioportal.security.spring.authentication.saml.SAMLUserDetailsServiceImpl
                            </saml.custom.userservice.class>
                            <saml.logout.local>false</saml.logout.local>
                            <!--FIXME Our test saml idp does not sign assertions for some reason-->
                            <saml.sp.metadata.wantAssertionSigned>false</saml.sp.metadata.wantAssertionSigned>
                            <saml.logout.url>/</saml.logout.url>
                            <dat.method>oauth2</dat.method>
                            <dat.oauth2.clientId>client_id</dat.oauth2.clientId>
                            <dat.oauth2.clientSecret>client_secret</dat.oauth2.clientSecret>
                            <dat.oauth2.issuer>token_issuer</dat.oauth2.issuer>
                            <dat.oauth2.accessTokenUri>http://localhost:8443/auth/realms/cbio/token</dat.oauth2.accessTokenUri>
                            <dat.oauth2.redirectUri>http://localhost:8080/api/data-access-token/oauth2</dat.oauth2.redirectUri>
                            <dat.oauth2.userAuthorizationUri>http://localhost:8443/auth/realms/cbio/auth</dat.oauth2.userAuthorizationUri>
                            <dat.oauth2.jwkUrl>http://localhost:8443/auth/realms/cbio/jwkUrl</dat.oauth2.jwkUrl>
                            <dat.oauth2.jwtRolesPath>resource_access::cbioportal::roles</dat.oauth2.jwtRolesPath>
                        </systemProperties>
                    </container>
                    <configuration>
                        <properties>
                            <cargo.servlet.port>8080</cargo.servlet.port>
                            <cargo.jvmargs>
                                -Xms2g
                                -Xmx4g
                            </cargo.jvmargs>
                        </properties>
                    </configuration>
                    <wait>false</wait>
                    <deployables>
                        <deployable>
                            <groupId>org.mskcc.cbio</groupId>
                            <artifactId>cbioportal</artifactId>
                            <type>war</type>
                            <location>${env.CBIO_WAR_LOCATION}</location>
                        </deployable>
                        <deployable>
                            <groupId>org.mskcc.cbio</groupId>
                            <artifactId>saml-idp</artifactId>
                            <type>war</type>
                            <location>${project.basedir}/saml-idp/target/saml-idp.war</location>
                        </deployable>
                    </deployables>
                </configuration>
                <executions>
                    <execution>
                        <id>start-server</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>start</goal>
                        </goals>
                    </execution>
                    <execution>
                        <id>stop-server</id>
                        <phase>post-integration-test</phase>
                        <goals>
                            <goal>stop</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <artifactId>maven-failsafe-plugin</artifactId>
                <version>3.0.0-M4</version>
                <configuration>
                    <includes>
                        <include>**/*IntegrationTests</include>
                    </includes>
                    <trimStackTrace>false</trimStackTrace>
                </configuration>
                <executions>
                    <execution>
                        <goals>
                            <goal>integration-test</goal>
                            <goal>verify</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
